<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>君に会いたい ...Sprinter - tech</title><link href="https://jackyzy823.github.io/" rel="alternate"></link><link href="https://jackyzy823.github.io/feeds/tech.atom.xml" rel="self"></link><id>https://jackyzy823.github.io/</id><updated>2024-11-15T01:40:00+08:00</updated><entry><title>一加日历接口不再更新</title><link href="https://jackyzy823.github.io/tech/one-plus-calendar-api-no-longer-update.html" rel="alternate"></link><published>2024-01-01T18:00:00+08:00</published><updated>2024-01-01T18:00:00+08:00</updated><author><name>jackyzy823</name></author><id>tag:jackyzy823.github.io,2024-01-01:/tech/one-plus-calendar-api-no-longer-update.html</id><summary type="html">&lt;h3&gt;-TL;DR-&lt;/h3&gt;
&lt;p&gt;老手机+系统的宿命：依赖的中国特色服务不再更新了。&lt;/p&gt;
&lt;h3&gt;-Intro-&lt;/h3&gt;
&lt;p&gt;时间已经来到了2024年，虽然设置了仅工作日的手机闹钟，但是 …&lt;/p&gt;</summary><content type="html">&lt;h3&gt;-TL;DR-&lt;/h3&gt;
&lt;p&gt;老手机+系统的宿命：依赖的中国特色服务不再更新了。&lt;/p&gt;
&lt;h3&gt;-Intro-&lt;/h3&gt;
&lt;p&gt;时间已经来到了2024年，虽然设置了仅工作日的手机闹钟，但是元旦早上还是被吵醒，因为它不知道今天是节假日。&lt;/p&gt;
&lt;h3&gt;-Analysis-&lt;/h3&gt;
&lt;p&gt;通过X-plore提取日历APK，拖到jadx里分析出接口。&lt;/p&gt;
&lt;p&gt;流程如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;鉴权&lt;/p&gt;
&lt;p&gt;&lt;code&gt;curl -X POST https://appr.1plus.io/v1/auth/calendar/token -A "com.oneplus.calendar/1.0.0" -d '{"client_id":"14254102-04f7-11ea-bb4e-804a145e0928", "client_secret":"1b9dc1d4-04f7-11ea-bb4e-804a145e0928"}'&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;返回Token： &lt;code&gt;{"token":"eyxxxxxxx.xxxxxxxx.xxxxxxxx"}&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;获取&lt;/p&gt;
&lt;p&gt;&lt;code&gt;curl "https://appr.1plus.io/v1/app/calendar" -H "Authorization: Bearer eyxxxxxxx.xxxxxxxx.xxxxxxxx" -A "com.oneplus.calendar/1.0.0"&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;返回302，以及一个链接 &lt;code&gt;https://app-resources.1plus.io/calendar/config/default/20221223/config.json?Expires=time&amp;amp;Signature=xxxx&amp;amp;Key-Pair-Id=xxxx&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;下载&lt;/p&gt;
&lt;p&gt;&lt;code&gt;curl -o holiday.json "https://app-resources.1plus.io/calendar/config/default/20221223/config.json?Expires=time&amp;amp;Signature=xxxx&amp;amp;Key-Pair-Id=xxxx"&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;返回内容:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;projectname&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;OPCalendar&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;content&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;NationalHolidays&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;value&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;startYear&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;2020&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;yearsIndex&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="mi"&gt;36&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="mi"&gt;74&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="mi"&gt;113&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="mi"&gt;146&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;holidays&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;                        &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;0&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;true&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;                        &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;18&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;false&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;                        &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;23&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;true&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="c1"&gt;//略&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;                        &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;0&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;true&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="c1"&gt;//略&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;                        &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;0&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;true&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="c1"&gt;//略&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;                        &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;0&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;true&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="c1"&gt;//略&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;                        &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;279&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;false&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;                        &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;280&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;false&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code&gt;yearIndex&lt;/code&gt;代表&lt;code&gt;holidays&lt;/code&gt;数组的第x位开始为该年度的节假日，2024年应该从146开始，可是整个&lt;code&gt;holidays&lt;/code&gt;数组也就146项，也就是所并没有2024年的数据。&lt;/p&gt;
&lt;p&gt;从链接也能发现，最后一次更新是&lt;code&gt;20221223&lt;/code&gt;。一开始还以为服务没了，例如域名没了等等，现在发现只是没有人去维护更新数据了。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;-Solution-&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;放弃，风险点在于，补班的日子没闹钟。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;MITM，修改响应内容，然后禁用自动更新以防止被旧的覆盖。(似乎需要系统证书，因为在Fiddler中还是显示的是HTTPS CONNECT，意味着需要root设备)&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;-Outro-&lt;/h3&gt;
&lt;p&gt;在写作的时候，收到一个非常旧的vivo备机的明日上班的提醒，点进去一看人家就更新了2024的节假日安排。只能说一加确实不&lt;strong&gt;讲究&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;尽管&lt;em&gt;大氢亡了&lt;/em&gt;，作为前朝余孽，还是拒绝将一加7T升级到ColorOS。&lt;/p&gt;
&lt;p&gt;&lt;del&gt;当然比某些国际大厂好一点，至少还曾经有过。&lt;/del&gt; &lt;a href="https://web.archive.org/web/20240105152651/https://weibo.com/2022252207/NArThaySS"&gt;分分钟打脸&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;Reference&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://web.archive.org/web/20240101104139/https://bbs.oneplus.com/thread/1496695386788593672"&gt;病友1&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://web.archive.org/web/20240101104034/https://bbs.oneplus.com/thread/1488566300006416389"&gt;病友2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://web.archive.org/web/20240101103706/https://bbs.oneplus.com/thread/1485760578604498950"&gt;病友3&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><category term="tech"></category><category term="oneplus"></category><category term="calendar"></category><category term="api"></category></entry><entry><title>Linux下 .Net 踩过的一些坑</title><link href="https://jackyzy823.github.io/tech/dotnet-under-linux.html" rel="alternate"></link><published>2022-09-24T00:00:00+08:00</published><updated>2022-09-24T00:00:00+08:00</updated><author><name>jackyzy823</name></author><id>tag:jackyzy823.github.io,2022-09-24:/tech/dotnet-under-linux.html</id><summary type="html">&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;dotnet framework / dotnet standard / dotnet core / dotnet 傻傻分不清楚 Ref: &lt;a href="https://learn.microsoft.com/en-us/dotnet/standard/frameworks"&gt;MSDN&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;版本 -&amp;gt; 语言特性&lt;/p&gt;
&lt;p&gt;匹配但又不完全匹配 .NetFramework4.5.2 不支持C#8.0，但如果在.csproj中加上在&lt;langVersion&gt;8.0 …&lt;/langversion&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;</summary><content type="html">&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;dotnet framework / dotnet standard / dotnet core / dotnet 傻傻分不清楚 Ref: &lt;a href="https://learn.microsoft.com/en-us/dotnet/standard/frameworks"&gt;MSDN&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;版本 -&amp;gt; 语言特性&lt;/p&gt;
&lt;p&gt;匹配但又不完全匹配 .NetFramework4.5.2 不支持C#8.0，但如果在.csproj中加上在&lt;langVersion&gt;8.0&lt;/langVersion&gt;或&lt;langVersion&gt;preview&lt;/langVersion&gt;就可以使用一部分特性，可惜最好用的Range/Indices却不能用。 Ref:  &lt;a href="https://stackoverflow.com/questions/56651472/does-c-sharp-8-support-the-net-framework"&gt;StackOverflow&lt;/a&gt;,&lt;a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/configure-language-version"&gt;MSDN&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;不使用 dotnet build/publish 命令&lt;/p&gt;
&lt;p&gt;编译: dotnet /usr/lib64/dotnet/sdk/&lt;sdk_version&gt;/Roslyn/bincore/csc.dll 后面就是常规的CSC参数 例如 &lt;code&gt;-lib:/usr/lib64/dotnet/shared/Microsoft.NETCore.App/&amp;lt;sdk_version&amp;gt;/&lt;/code&gt; 或 &lt;code&gt;-r&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;运行: &lt;code&gt;dotnet exec --runtimeconfig /usr/lib64/dotnet/sdk/&amp;lt;sdk_version&amp;gt;/dotnet.runtimeconfig.json &amp;lt;exe_file&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Ref: &lt;a href="https://stackoverflow.com/questions/46065777/is-it-possible-to-compile-a-single-c-sharp-code-file-with-the-net-core-roslyn-c"&gt;StackOverflow&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;打包成单个文件（带运行时）&lt;/p&gt;
&lt;p&gt;项目文件(.csproj)中 &lt;PropertyGroup&gt; 下增加&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;PublishSingleFile&amp;gt;&lt;/span&gt;true&lt;span class="nt"&gt;&amp;lt;/PublishSingleFile&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;SelfContained&amp;gt;&lt;/span&gt;true&lt;span class="nt"&gt;&amp;lt;/SelfContained&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;RuntimeIdentifier&amp;gt;&lt;/span&gt;linux-x64&lt;span class="nt"&gt;&amp;lt;/RuntimeIdentifier&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="cm"&gt;&amp;lt;!-- for: Unable to find package Microsoft.NETCore.App.Runtime.linux-x64 with version (= 6.0.0-rc.2.21470.23) --&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="cm"&gt;&amp;lt;!--      NU1102:   - Found 98 version(s) in nuget.org [ Nearest version: 6.0.0-rc.2.21480.10 ] --&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="cm"&gt;&amp;lt;!-- https://learn.microsoft.com/en-us/dotnet/core/project-sdk/msbuild-props#runtimeframeworkversion --&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;RuntimeFrameworkVersion&amp;gt;&lt;/span&gt;6.0.9&lt;span class="nt"&gt;&amp;lt;/RuntimeFrameworkVersion&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;RID(RuntimeIdentifier) Ref: &lt;a href="https://learn.microsoft.com/en-us/dotnet/core/rid-catalog"&gt;MSDN&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;RuntimeFrameworkVersion是为了避免Nuget.org上下不到你SDK版本对应的运行时。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;不想使用在线Nuget&lt;/p&gt;
&lt;p&gt;项目目录下新建 nuget.config。内容：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&amp;lt;configuration&amp;gt;
&amp;lt;packageSources&amp;gt;
&amp;lt;clear&amp;gt;
&amp;lt;add key=&amp;quot;local&amp;quot; value=&amp;quot;&amp;lt;path&amp;gt;&amp;quot;
&amp;lt;/packageSources&amp;gt;
&amp;lt;/configuration&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;将下载好的.nuget包放进&lt;code&gt;&amp;lt;path&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;使用Omnisharp-Vim 如果遇到Found 0 Instance问题&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;let g:OmniSharp_server_use_net6 = 1&lt;/code&gt; 然后重装 &lt;code&gt;:OmniSharpInstall&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;如果你的sdk_version带&lt;code&gt;rc&lt;/code&gt;（预览版本），新建 ~/.omnisharp/omnisharp.json&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;SDK&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;includePrereleases&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;true&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;/ol&gt;</content><category term="tech"></category><category term="csharp"></category><category term="dotnet"></category></entry><entry><title>QMailAgent架构分析及破解</title><link href="https://jackyzy823.github.io/tech/qmailagent-analysis-and-crack.html" rel="alternate"></link><published>2022-06-20T14:32:00+08:00</published><updated>2022-06-20T14:32:00+08:00</updated><author><name>jackyzy823</name></author><id>tag:jackyzy823.github.io,2022-06-20:/tech/qmailagent-analysis-and-crack.html</id><summary type="html">&lt;p&gt;注: 本次破解仅在QMailAgent 3.1.1下测试通过，不对未来版本做保证。&lt;/p&gt;
&lt;h2&gt;起因&lt;/h2&gt;
&lt;p&gt;受够了Gmail网页版的内存占用及其他一系列的心理障碍 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;注: 本次破解仅在QMailAgent 3.1.1下测试通过，不对未来版本做保证。&lt;/p&gt;
&lt;h2&gt;起因&lt;/h2&gt;
&lt;p&gt;受够了Gmail网页版的内存占用及其他一系列的心理障碍，迫切需要一个自建的支持一个登陆帐号内包含多个不同提供商(Gmail,Outlook等)的邮箱帐号的多平台（至少Web和安卓）聚合邮件系统(mail aggregator)。然而找了一圈市面上的解决方案都不符合我的心意。&lt;/p&gt;
&lt;p&gt;Roundcube不支持多帐号，安卓上也没有客户端。NextCloud Mail虽然不错，可惜我没有NextCloud生态。也看过SOGOs和Horde都不太符合心意。&lt;/p&gt;
&lt;p&gt;还有就是 QMailAgent 主要是因为家里有NAS且有安卓客户端，在有公网IP的情况下，安卓端的作用可以最大化。但是由于我想收Gmail,然而此地受限网络环境不允许。&lt;/p&gt;
&lt;p&gt;我甚至动了自己写的心，包括但不限于修改NextCloud Mail或QMailAgent使其独立于其平台，但是开发安卓客户端实在是太麻烦了。最终还是妥协了，选择了QMailAgent，使用透明代理改造了本地的网络，使之能访问GMail。&lt;/p&gt;
&lt;h2&gt;经过&lt;/h2&gt;
&lt;p&gt;在尝试魔改QMailAgent的时候，对其进行了逆向工程，分析了其架构，并破解了Premium的限制。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;代码分析&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;通过下载&lt;a href="https://download.qnap.com.cn/QPKG/qmailagent_3.1.1_20220524_x86_64.zip"&gt;QPKG包&lt;/a&gt;并使用&lt;a href="https://github.com/max-boehm/qnap-utils"&gt;工具&lt;/a&gt; 解包，其中的Python字节码(*.pyc) 可以通过uncompyle6来反编译。&lt;/p&gt;
&lt;p&gt;纵览代码可以发现QMailAgent整体上是由RoundCube 1.1.2加上自己写的Plugins（包括多帐号，备份还原，与FileStation交互等功能）在加上部分用于处理IMAP和POP3的Python库组成，例如 offlineimap ，例如使用Got-your-back 0.21 (非常老旧的版本)来支持GMail的获取。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Premium破解&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;接下来就是Premium破解，不建议从license文件本身入手，因为我有过失败的尝试经历，除非一辈子不联网，否则QNAP是强制网络验证license的，比较难搞。&lt;/p&gt;
&lt;p&gt;通过前端的入口 &lt;code&gt;_task=license&amp;amp;_action=get_info&lt;/code&gt; 找到 &lt;code&gt;data/web/plugins/license/license.php&lt;/code&gt; 中的 &lt;code&gt;$this-&amp;gt;register_action('get_info', array($this, 'get_info_ajax'));&lt;/code&gt;,进而找到&lt;code&gt;get_info_ajax&lt;/code&gt; 函数，这里发现其调用了一个明显混淆过的函数&lt;code&gt;$info = $this-&amp;gt;rcmail-&amp;gt;license-&amp;gt;wbf2d66a297();&lt;/code&gt;，找到其定义的php文件&lt;code&gt;data/web/program/lib/Qmail/obfuscator/qmail_license.php&lt;/code&gt;，显然obfuscator文件夹下的php文件都进行过混淆以保护代码，虽然可以手动恢复，但为了以后方便还是写了一个脚本自动反混淆，再用格式美化工具格式化一下就可以轻松阅读，甚至能够运行，至少直接&lt;code&gt;php xx.php&lt;/code&gt;不会报错。&lt;/p&gt;
&lt;p&gt;通过搜索所有包含&lt;code&gt;qmail_license.php&lt;/code&gt;中的类名及&lt;code&gt;-&amp;gt;license&lt;/code&gt;的代码，发现所有付费功能在调用前都没有验证license，这也可以从&lt;code&gt;data/web/plugins/license/license.min.js&lt;/code&gt;前端代码中进一步得到验证，又是可爱的前端验证，详见&lt;a href="https://jackyzy823.github.io/tech/bad-geolocation-restriction-design.html"&gt;之前的文章&lt;/a&gt;。这和QSirch、CAIYIN MediaSign之类的有所不同，它们都是在后端二进制文件中验证license的，相比而言防御等级更胜一筹。&lt;/p&gt;
&lt;p&gt;所以可以通过Console控制台(F12)或者油猴等方式，每次运行时绕过前端的验证。也可以在代码前面加上&lt;code&gt;javascript:&lt;/code&gt;后&lt;a href="https://stackoverflow.com/questions/18872679/function-as-google-chrome-bookmark"&gt;存入书签&lt;/a&gt;，放在书签栏上。因为用到Premium功能的频率不高，我觉得通过Console控制台(F12)修改是可以接受的。&lt;/p&gt;
&lt;p&gt;QNAP通过iframe的形式整合QMailAgent及其他应用，QMailAgent 的 iframe的id为 ext-gen+随机数+qmail ，因此可以通过css属性来找到这个iframe，详细javscript如下，伪造了一个到2099-12-31到期的license:
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nb"&gt;document&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;querySelectorAll&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;[id^=ext-gen][id$=qmail]&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nx"&gt;forEach&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;k&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nx"&gt;k&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;contentWindow&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;rcmail&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;license&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;stop_refresh&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nx"&gt;k&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;contentWindow&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;rcmail&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;license&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;update&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;info&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;license&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;status&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;id&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Default&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Default&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;info&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid_from&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid_until&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;apply_date&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enable_func&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;add_account&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;limit&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mf"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;expired_soon&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;false&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;status&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;id&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Test&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Test&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;info&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid_from&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2020-01-01&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid_until&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2099-12-31&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;apply_date&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2020-01-01&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enable_func&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;add_account&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;limit&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mf"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;backup&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;{},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;restore&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;{},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;merge&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;{},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;expired_soon&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;false&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;merge_func&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;add_account&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;limit&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mf"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid_from&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid_until&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;apply_date&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;expired_soon&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;false&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;backup&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;{},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;restore&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;{},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;merge&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;{},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;is_premium&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;true&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;unlimit&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mf"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;如果是直接以&lt;code&gt;http://NAS/qmail&lt;/code&gt;形式访问QMailAgent则可以简化为：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nx"&gt;rcmail&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;license&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;stop_refresh&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="nx"&gt;rcmail&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;license&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;update&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;info&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;license&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;status&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;id&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Default&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Default&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;info&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid_from&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid_until&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;apply_date&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enable_func&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;add_account&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;limit&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mf"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;expired_soon&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;false&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;status&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;id&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Test&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Test&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;info&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid_from&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2020-01-01&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid_until&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2099-12-31&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;apply_date&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2020-01-01&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enable_func&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;add_account&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;limit&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mf"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;backup&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;{},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;restore&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;{},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;merge&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;{},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;expired_soon&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;false&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;merge_func&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;add_account&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;limit&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mf"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid_from&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;valid_until&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;apply_date&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;expired_soon&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;false&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;backup&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;{},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;restore&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;{},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;merge&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;{},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;is_premium&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;true&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;unlimit&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mf"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;因为所有付费功能在调用前都没有验证license，所以如果能SSH连进NAS的话可以直接调用&lt;code&gt;/mnt/ext/opt/qmail/web/restoreworker.sh&lt;/code&gt;和&lt;code&gt;/mnt/ext/opt/qmail/web/backupworker.sh&lt;/code&gt;等工具。&lt;/p&gt;
&lt;p&gt;甚至可以更加直接一点，通过mysqldump命令备份数据库，并手动备份邮件存储的文件夹。需要恢复的时候，再导入即可。 其中mysql数据库的连接方式为  &lt;code&gt;/usr/local/mariadb/bin/mysql -uroundcube -pmypassword  -S /mnt/ext/opt/qmail/var/qmail_mysqld.sock&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用透明代理改造本地网络&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;改造本地网络前提是gmail、google accounts和googleapis域名没有被污染， 如果污染了就要另外增加自建DNS的步骤。google本身的主域名被污染无所谓。&lt;/p&gt;
&lt;p&gt;我们要做的就是让所有google的IP经过我们的透明代理，那么Google的IP哪里查呢？像这些大厂都会公布自己的IP段，供运维人员配置防火墙等等，可以从&lt;code&gt;https://www.gstatic.com/iprange/goog.json&lt;/code&gt;获取所有的IP段，令人惊奇的是www域名（指向了国内的IP，北京谷歌云）没被墙，而裸域名被墙了。&lt;/p&gt;
&lt;p&gt;使用SSH连接NAS，首先 &lt;code&gt;sudo ipset create google hash:net family inet&lt;/code&gt; 建立google的IP集合。然后 &lt;code&gt;curl https://www.gstatic.com/ipranges/goog.json |  jq -r ".prefixes[].ipv4Prefix | values"  | xargs -n 1 sudo ipset add google&lt;/code&gt; 将Google的IP加入集合中(这里我们暂时不考虑ipv6)。接下来建立iptables的转发规则将命中Google IP的流量转发到透明代理，其他流量原样处理(这里我们暂时只考虑TCP协议)。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;sudo iptables -t nat -N google
sudo iptables -t nat -A google -m set ! --match-set google dst -j RETURN
sudo iptables -t nat -A google -p tcp -j REDIRECT --to-ports 2080
sudo iptables -t nat -A PREROUTING -j google
sudo iptables -t nat -A OUTPUT -p tcp  -j google
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最后，使用QNAP的Container Station创建透明代理的container。这里需要注意的是container的网络模式必须为host模式，这样透明代理程序才能通过iptables知道修改前的源IP、端口，否则无法转发。你可以使用任何你喜欢的支持透明代理模式的工具。别忘了设置自动启动。&lt;/p&gt;
&lt;p&gt;改造完成后别忘了通过开机启动项autorun.sh (Control Panel-&amp;gt;System-&amp;gt;Hardware-&amp;gt;General-&amp;gt;Run user defined processes during startup) 来持久化操作，因为每次重启后iptables都不会保存。具体内容为之前所有的命令，把sudo去除即可。&lt;/p&gt;
&lt;h2&gt;结果&lt;/h2&gt;
&lt;p&gt;真香&lt;/p&gt;
&lt;h2&gt;One More Thing&lt;/h2&gt;
&lt;p&gt;最近听闻K-9加入ThunderBird，就在想Thunderbird能不能出个Headless的然后扔在VPS上收邮件，然后本地ThunderBird和安卓端通过WEB API来访问/同步。
或者加入FxA全家桶，利用Firefox Sync来同步设置邮件（可能对对于Mozilla来说负担有些大）。&lt;/p&gt;
&lt;p&gt;Update 2022-07-31:
刚刚看syncstorage-rs的issue是发现了&lt;a href="https://github.com/mozilla-services/syncstorage-rs/issues/1363"&gt;Thunderbird也要开始使用Firefox Sync&lt;/a&gt;以及&lt;a href="https://thunderbird.topicbox.com/groups/planning/T0032198a6351e77d/proposal-firefox-sync-in-114-should-be-called-thunderbird-sync"&gt;将Firefox Sync重命名为Mozilla Sync的讨论&lt;/a&gt;。搜索了一下关于ThunderBird 114(2023年)相关的&lt;a href="https://www.ghacks.net/2022/07/25/thunderbirds-next-milestone-release-will-support-firefox-sync/"&gt;新闻&lt;/a&gt;,真是令人期待。从&lt;a href="https://developer.thunderbird.net/planning/roadmap#firefox-sync"&gt;Roadmap&lt;/a&gt;来看 1. 起码要等到年底甚至更久。 2. Android端（也就是K9）也会支持，应该说正是因为收购了Android端才开始考虑同步这个功能。 3. 只同步邮箱设置，不同步邮件内容。可以理解，毕竟Sync提供的存储有上限也不大。不如搞成收费的来缓解财政压力，可以学习现在流行的订阅制收费模式嘛。&lt;/p&gt;
&lt;p&gt;附： 反混淆用的Python脚本 &lt;del&gt;无内鬼，来点正则表达式笑话。&lt;/del&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;re&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="nn"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="nn"&gt;zlib&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;!=&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Usage: deobfs xxx.php&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;


&lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;rb&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="c1"&gt;## Remove define&lt;/span&gt;
&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sub&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;define\(.*?\);&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; 

&lt;span class="c1"&gt;## Extract gz content&lt;/span&gt;
&lt;span class="n"&gt;res&lt;/span&gt;  &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;findall&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;rb&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&amp;quot;(?s)\$(.*?)\[(.*?)\]\s=\sexplode\(&amp;#39;(.*?)&amp;#39;\s*,\s*gzinflate\(substr\(&amp;#39;(.*?)&amp;#39;\s*,(.*?)\s*,(.*?)\s*\)\)\);&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;[:&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;find&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;)));&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;  &lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; 
&lt;span class="n"&gt;global_obj&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;global_key&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;split_key&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt;  &lt;span class="n"&gt;gz&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;start&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;end&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;res&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;gz1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gz&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;decode&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt;&lt;span class="mi"&gt;16&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;end&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;decode&lt;/span&gt;&lt;span class="p"&gt;())]&lt;/span&gt;

&lt;span class="c1"&gt;# TODO: https://www.php.net/manual/en/language.types.string.php&lt;/span&gt;
&lt;span class="c1"&gt;## \r \v \e \f&lt;/span&gt;
&lt;span class="n"&gt;gz1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gz1&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;rb&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;\&amp;#39;&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\&amp;#39;&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;rb&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;\&amp;quot;&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;rb&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;\$&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;\$&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;rb&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;\n&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;rb&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;\t&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\t&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;rb&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# beacuse php escape it&lt;/span&gt;

&lt;span class="n"&gt;g&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;zlib&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;decompressobj&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;zlib&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;MAX_WBITS&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;decompress&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gz1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;gl&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;g&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;split_key&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;s1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;[:&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;find&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;)));&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;  &lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;s2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sub&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;rb&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&amp;quot;(?s)\$(.*?)\[(.*?)\]\s=\sexplode\(&amp;#39;(.*?)&amp;#39;\s*,\s*gzinflate\(substr\(&amp;#39;(.*?)&amp;#39;\s*,(.*?)\s*,(.*?)\s*\)\)\);&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s1&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; 
&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;s1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;s2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;## Remove `$KEY = &amp;amp;_GLOBAL` and Replace all $KEY to $_GLOBAL&lt;/span&gt;
&lt;span class="n"&gt;ref_args&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;findall&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;rb&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&amp;quot;\$([^\)]*?)\=\&amp;amp;\$&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;global_obj&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;ref_args&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;set&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ref_args&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="c1"&gt;#dedupe&lt;/span&gt;
&lt;span class="n"&gt;ref_args&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sort&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;reverse&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;ref_arg&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;ref_args&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;$&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;ref_arg&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;=&amp;amp;$&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;global_obj&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;[&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;global_key&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;];&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;$&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;ref_arg&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;[&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;$&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;global_obj&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;[&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;global_key&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;][&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;## Replace malformed arguments&lt;/span&gt;
&lt;span class="n"&gt;res&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;findall&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;rb&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;#39;&amp;#39;(\$[\W]*?)[\=|\!|,|)|\[|&amp;gt;|\]|\-|\:|\.|\;|\&amp;lt;]&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;rep&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;set&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;res&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;rep&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sort&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;reverse&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;v&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;enumerate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;rep&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;v&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;$arg&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;encode&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;## Replace dict with its item.&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;replace_word&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;word&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;  &lt;span class="n"&gt;gl&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;group&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;decode&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt;&lt;span class="mi"&gt;16&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  &lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;word&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;DateTime&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;DateTimeZone&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;restoreworker&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;backupworker&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;word&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;quot;&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;word&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;quot;&amp;#39;&lt;/span&gt;

&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sub&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;rb&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;\$&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt;  &lt;span class="n"&gt;global_obj&lt;/span&gt;  &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;\[&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;global_key&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;\]\[(.*?)\]&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;replace_word&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;## Output&lt;/span&gt;
&lt;span class="k"&gt;with&lt;/span&gt;  &lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;.dec&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;wb&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/p&gt;</content><category term="tech"></category><category term="QMailAgent"></category><category term="crack"></category><category term="analysis"></category><category term="破解"></category></entry><entry><title>白嫖(破解)Zorin OS Pro/Ultimate</title><link href="https://jackyzy823.github.io/tech/zorin-os-pro-upgrade.html" rel="alternate"></link><published>2022-01-03T14:20:00+08:00</published><updated>2024-11-15T01:40:00+08:00</updated><author><name>jackyzy823</name></author><id>tag:jackyzy823.github.io,2022-01-03:/tech/zorin-os-pro-upgrade.html</id><summary type="html">&lt;h3&gt;总结：&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;在 &lt;code&gt;/etc/apt/sources.list.d/zorin.list&lt;/code&gt; 添加 &lt;code&gt;deb https://packages.zorinos.com/premium bionic main&lt;/code&gt;。其中Zorin 15 对应的是bionic，Zorin 16 对应的是focal, Zorin 17 对应的是jammy。如果需要源码再 …&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;</summary><content type="html">&lt;h3&gt;总结：&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;在 &lt;code&gt;/etc/apt/sources.list.d/zorin.list&lt;/code&gt; 添加 &lt;code&gt;deb https://packages.zorinos.com/premium bionic main&lt;/code&gt;。其中Zorin 15 对应的是bionic，Zorin 16 对应的是focal, Zorin 17 对应的是jammy。如果需要源码再添加&lt;code&gt;dec-src https://packages.zorinos.com/premium bionic main&lt;/code&gt; &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;新增 &lt;code&gt;/etc/apt/apt.conf.d/99zorin-os-premium-user-agent-temp&lt;/code&gt; 增加 &lt;code&gt;Acquire {  http::User-Agent "Zorin Os Premium" }&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;注意 Zorin 17 会报错 &lt;code&gt;The following signatures couldn't be verified because the public key is not available: NO_PUBKEY 5FD7496A07D323BC&lt;/code&gt; 可以 1) &lt;code&gt;curl -sS https://packages.zorinos.com/zorin_os_key.asc | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/zorin.gpg&lt;/code&gt; 或 2) &lt;code&gt;sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys  5FD7496A07D323BC&lt;/code&gt; 参考 https://github.com/PEAKYCOMMAND/Zorin-OS-Pro/blob/main/zorin.sh&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&amp;lt;可选&amp;gt; 完成后，&lt;code&gt;apt update &amp;amp;&amp;amp; apt install apt-user-agent-zorin-os-premium&lt;/code&gt; ， 并删除 &lt;code&gt;/etc/apt/apt.conf.d/99zorin-os-premium-user-agent-temp&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&amp;lt;可选&amp;gt; 更多布局 &lt;code&gt;apt install zorin-apperance-layouts-shell-premium zorin-apperance-layouts-xfce-premium&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&amp;lt;可选&amp;gt; 如果对Premium源包含哪些软件包感兴趣，可以查看 &lt;code&gt;/var/lib/apt/lists/premium&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;TL;DR&lt;/strong&gt;&lt;/p&gt;
&lt;h3&gt;为什么&lt;/h3&gt;
&lt;p&gt;之前试用某个版本的Manjaro Gnome，发现引入了&lt;a href="https://gitlab.manjaro.org/Chrysostomus/gnome-layout-switcher"&gt;Gnome Layout Switcher&lt;/a&gt;功能，里面有多种界面风格可以选择，实现的原理是组合Gnome Shell不同的插件实现风格的切换，然后从项目的描述中(A simple gui for choosing gnome layout. Inspired by the similar application by Zorin os)看到灵感来源于Zorin OS。&lt;/p&gt;
&lt;p&gt;出于猎奇心理，迫不及待下载试用。官网还有收费的Pro（以前叫Ultimate）版本，此外收费版的大版本升级仍然要重新付费。收费版只比普通版多了几个可以切换的布局，外加Xfce桌面环境和一些生产力软件。&lt;/p&gt;
&lt;h3&gt;猜想并验证&lt;/h3&gt;
&lt;p&gt;开始思考，Zorin OS是怎么区别普通版还是收费版，第一反应就是软件源做了限制：观察普通版(Core)的Zorin的APT源地址， 访问 &lt;code&gt;https://packages.zorinos.com/&lt;/code&gt; 发现存在&lt;code&gt;premium&lt;/code&gt;目录。直接点击会跳转到介绍页面。看到这种现象，猜测有某种认证机制，第二反应就是根据HTTP头例如User-Agent等来判断的。以前也看到过文章讲&lt;a href="https://dmfrsecurity.com/2018/12/10/changing-apts-user-agent-string/"&gt;如何修改APT的User-Agent&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;那么如何验证猜想呢，通过搜索，找到了一个Premium的镜像下载链接，好孩子们不要学。虚拟机挂载进行进入Live模式，列出软件包和APT的设置，果然如此。&lt;/p&gt;
&lt;p&gt;那么问题来了，我为什么不一开始就这么做呢？逐渐开始怀疑人生。只能安慰自己，等出了新版本，不用找盗版下载链接，直接从普通版升级上去。&lt;/p&gt;
&lt;h3&gt;杂谈&lt;/h3&gt;
&lt;p&gt;Zorin我也只是试用一下，本身Ubuntu已经是二次发行版了（虽然比Debian更流行），Zorin更是二次发行的二次发行。当然吐槽归吐槽，收费版本是他的商业模式也无可厚非，只能说一个愿打一个愿挨。有闲钱的还是可以赞助一下开源项目，但是对于我来说39刀真的有点贵。界面是挺好看的，也确实要花时间人力来设计，但是elementaryOS都没你的贵，而且人家还是自愿捐款（Update:&lt;a href="https://news.ycombinator.com/item?id=30611748"&gt;好吧，我乌鸦嘴了&lt;/a&gt;）。&lt;/p&gt;</content><category term="tech"></category><category term="zorin"></category><category term="bypass"></category><category term="crack"></category><category term="pro"></category><category term="premium"></category><category term="ultimate"></category><category term="破解"></category></entry><entry><title>ThinkPad Linux镜像</title><link href="https://jackyzy823.github.io/tech/thinkpad-linux-image.html" rel="alternate"></link><published>2022-01-02T14:00:00+08:00</published><updated>2022-01-02T14:00:00+08:00</updated><author><name>jackyzy823</name></author><id>tag:jackyzy823.github.io,2022-01-02:/tech/thinkpad-linux-image.html</id><summary type="html">&lt;h3&gt;&lt;strong&gt;TL;DR&lt;/strong&gt;&lt;/h3&gt;
&lt;p&gt;总结：Lenovo垃圾前端。&lt;/p&gt;
&lt;p&gt;链接/Link: https://pcsupport.lenovo.com/us/en/api/v4/lenovorecovery/linuxRdvdConfig&lt;/p&gt;
&lt;p&gt;内容/Content:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;installationIntroduction&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Linux_Support_Product_List.PDF&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;operatingSystem&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Ubuntu&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;installationIntroduction&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu_OEM …&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">&lt;h3&gt;&lt;strong&gt;TL;DR&lt;/strong&gt;&lt;/h3&gt;
&lt;p&gt;总结：Lenovo垃圾前端。&lt;/p&gt;
&lt;p&gt;链接/Link: https://pcsupport.lenovo.com/us/en/api/v4/lenovorecovery/linuxRdvdConfig&lt;/p&gt;
&lt;p&gt;内容/Content:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;installationIntroduction&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Linux_Support_Product_List.PDF&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;operatingSystem&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Ubuntu&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;installationIntroduction&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu_OEM_Install.PDF&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;mappingList&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20R3,20R4&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;L13&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-L13-20191115-174.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20U1,20U2&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;L14&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-L14-20200609-225.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20U3,20U4&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;L15&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-L15-20200728-237.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20T4,20T5&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;P15s&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-T14_T15_P15s-20200720-69.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20TQ,20TR&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;P15v&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-T15p_P15v-20200820-87.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;30E0,30E1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;P620&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-P620-20201030-422.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20S0,20S1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;T14&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-T14_T15_P15s-20200720-69.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20UD,20UE&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;T14 AMD&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-T14AMD_T14sAMD_X13AMD-20200914-91.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20T0,20T1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;T14s&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-T14s_X13-20200615-60.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20UH,20UJ&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;T14s AMD&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-T14AMD_T14sAMD_X13AMD-20200914-91.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20S6,20S7&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;T15&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-T14_T15_P15s-20200720-69.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20TN,20TM&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;T15p&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-T15p_P15v-20200820-87.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20U9,20UA&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;X1 Carbon 8th Gen&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-X1C8-20200818-76.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20UB,20UC&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;X1 Yoga 5th Gen&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-X1Y5-20200429-57.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20T2,20T3&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;X13&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-T14s_X13-20200615-60.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20SX,20SY&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;X13 Yoga&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-X13Yoga-20200527-59.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20UF,20UG&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;X13 AMD&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Ubuntu-T14AMD_T14sAMD_X13AMD-20200914-91.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;}]},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;operatingSystem&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Fedora&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;installationIntroduction&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Fedora_Install.PDF&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;mappingList&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20U9,20UA&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;X1 Carbon 8th Gen&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Fedora_Workstation_Live_x86_64_32_1.6_X1C8_P1G2_P53.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20QT,20QU&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;P1 Gen 2&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Fedora_Workstation_Live_x86_64_32_1.6_X1C8_P1G2_P53.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20TH,20TJ&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;P1 Gen 3&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Fedora_Workstation_Live_x86_64_33_1.2_P1G3_P15.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20QN,20QQ&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;P53&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Fedora_Workstation_Live_x86_64_32_1.6_X1C8_P1G2_P53.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;machineType&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;20ST,20SU&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;productName&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;P15&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;downloadLink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://download.lenovo.com/km/media/attachment/Fedora_Workstation_Live_x86_64_33_1.2_P1G3_P15.iso&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;}]}]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;细节&lt;/h3&gt;
&lt;p&gt;因为打算买&lt;a href="https://jackyzy823.github.io/rambling/rambling-about-picking-thinkpad.html"&gt;ThinkPad&lt;/a&gt;，考虑下一台设备主用Linux。ThinkPad有OEM版本的Ubuntu/Fedora，对笔记本的各种新硬件稍微适配了驱动。然而这些镜像却没地方下载，或者说搜索不到。这种&lt;a href="https://pcsupport.lenovo.com/us/en/solutions/ht512169"&gt;帮助页面&lt;/a&gt;还不如没有。&lt;/p&gt;
&lt;p&gt;通过另一个&lt;a href="https://pcsupport.lenovo.com/us/en/solutions/ht511743-how-to-download-the-linux-image-from-the-e-support-page"&gt;官方帮助文档&lt;/a&gt;中的图片，发现PC Support应该有下载，但是怎么也找不到图片中的链接，你说Windows因为授权、费用等问题必须要注册并验证机器才能下载可以理解，Linux镜像就没必要吧。举例：&lt;a href="https://pcsupport.lenovo.com/us/en/products/laptops-and-netbooks/thinkpad-l-series-laptops/thinkpad-l15-type-20u3-20u4/downloads/order-recovery-media"&gt;L15&lt;/a&gt;恢复镜像的下载页面。而且即使注册了账号，仍然不显示前述文档中的链接，我甚至一度考虑暴力遍历找到合适机型的序列号。&lt;/p&gt;
&lt;p&gt;难道隐藏在网页页面里吗？抱着这个猜想打开了DevTools，发现了事情的真相：网络选项卡里有着这么一个请求&lt;code&gt;https://pcsupport.lenovo.com/us/en/api/v4/lenovorecovery/linuxRdvdConfig&lt;/code&gt;，内容就是心心念念的镜像链接。&lt;/p&gt;
&lt;p&gt;那么问题来了？既然又请求，为什么不显示呢？&lt;/p&gt;
&lt;p&gt;通过字符串搜索加断点大法，找到相关处理逻辑，结果令人哭笑不得。&lt;/p&gt;
&lt;p&gt;&lt;a href="https://pcsupport.lenovo.com/esv4/js/chunk-common.5e36f246.js"&gt;发起的请求&lt;/a&gt;:
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nx"&gt;y&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="k"&gt;return&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;i&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;a&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;r&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;UrlUtility&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nx"&gt;getFullPath&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/api/v4/lenovorecovery/linuxRdvdConfig&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)).&lt;/span&gt;&lt;span class="nx"&gt;then&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;e&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="k"&gt;return&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;e&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a href="https://pcsupport.lenovo.com/esv4/js/psp-downloads/order-recovery-media.cbeb43e5.js"&gt;调用者及回调函数&lt;/a&gt;:
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Object&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;p&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;h&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;])().&lt;/span&gt;&lt;span class="nx"&gt;then&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;t&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;                        &lt;/span&gt;&lt;span class="nx"&gt;t&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;data&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;n&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;linuxRecoveryConfig&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;JSON&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;t&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;data&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;其中在函数&lt;code&gt;judgeMtForLinux&lt;/code&gt;中遍历匹配并设置对应型号机器的镜像。发现&lt;code&gt;n.fedoraImageLink&lt;/code&gt;和&lt;code&gt;n.ubuntuImageLink&lt;/code&gt;赋值完后就没有后续的任何调用处理，更不用说前端的展示逻辑了。&lt;/p&gt;
&lt;p&gt;分析到这里，不得不佩服联想的前端。&lt;/p&gt;
&lt;p&gt;所以帮助文档里面的图是怎么截的？&lt;/p&gt;
&lt;h3&gt;彩蛋&lt;/h3&gt;
&lt;p&gt;发现了这么一处逻辑&lt;code&gt;n.blockLinux = "in" == window["MSELocaltionCountryByIP"],&lt;/code&gt;，虽然和之前的问题一样，没有任何后续的调用，但为什么要屏蔽印度呢？&lt;/p&gt;</content><category term="tech"></category><category term="thinkpad"></category><category term="image"></category><category term="iso"></category><category term="linux"></category><category term="fedora"></category><category term="ubuntu"></category></entry><entry><title>博客评论系统升级</title><link href="https://jackyzy823.github.io/tech/blog-comment-system-upgrade-2021.html" rel="alternate"></link><published>2021-11-30T13:50:00+08:00</published><updated>2021-11-30T13:50:00+08:00</updated><author><name>jackyzy823</name></author><id>tag:jackyzy823.github.io,2021-11-30:/tech/blog-comment-system-upgrade-2021.html</id><summary type="html">&lt;p&gt;好久没有在这个博客上写东西了，前段时间想在上面写点技术文章，然后发现原有的评论系统(Staticman)的公共服务因为被滥用 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;好久没有在这个博客上写东西了，前段时间想在上面写点技术文章，然后发现原有的评论系统(Staticman)的公共服务因为被滥用挂了，此外原有的发布系统(Travis)也不再免费。这两个挂了，都可以理解。&lt;/p&gt;
&lt;p&gt;说句题外话，Travis因为被Github Actions挤占了生存空间，不得不收缩资源。毕竟Github的爹Microsoft有自己的Azure云。但同样存在越收缩，就更多人转向Github Actions(例如我)，就越会被挤占这样赢者通吃的负反馈的情况。&lt;/p&gt;
&lt;p&gt;我这个人呢就是有强迫症，在一件事情想到自认为完美的解决方案之前，绝不会动手去实现。例如我现在维护的&lt;a href="https://github.com/jackyzy823/fxa-selfhosting"&gt;fxa-selfhosting&lt;/a&gt;项目，我自己还没有在实际环境里部署，因为各个方面都还有许多小问题。&lt;/p&gt;
&lt;p&gt;Staticman还是可以继续使用的，只是不能用公共实例，而需要在Heroku，或自己的VPS等计算平台上部署私有实例就可以继续使用。但是我不想注册Heroku账号，也不想为一个没什么人访问的博客，搞个VPS部署评论系统。也想过用Cloudflare Worker来实现Staticman的功能，但因为也要注册账号，并且可能还要修改Staticman的代码，就放弃了。也见过利用Vercel部署的&lt;a href="https://github.com/chinatimeline/chinatimeline-form"&gt;系统&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;进一步思考，这一类的评论系统最核心的部分就是在开启审核的情况下，发起Pull Requests到你的博客的Repository，在关闭审核的情况下直接提交Commit到Repository，而这些（包含部署到Vercel的）都是基于Github的API实现的。也就是说，我在博客前端，调用这些API也能做到这些功能，但进一步查阅API后发现，GITHUB_TOKEN的权限划分颗粒太粗，缺乏精确到每个Repository，每个功能的能力，例如我需要一个token只有对我某个Repository发Pull Requests的权限，目前为止是做不到的。&lt;/p&gt;
&lt;p&gt;以上为第一阶段的思考，思考完之后发现不完美，于是就搁置了下来，过了一段时间，我又重新燃起了写博客的想法，于是接着捡起来。因为本来就打算把发布系统换成Github Actions，于是思考能不能用Github Actions来做评论系统。&lt;/p&gt;
&lt;p&gt;查阅文档后发现，能够手动外部触发的只有&lt;code&gt;workflow_dispatch&lt;/code&gt;和&lt;code&gt;repository_dispatch&lt;/code&gt;两个事件，但这俩个事件也都需要Github Token，但我不死心，以&lt;code&gt;repository_dispatch anonymous&lt;/code&gt;为关键词搜索，发现了&lt;code&gt;Public Action Trigger&lt;/code&gt;这个Github Apps，完美解决了我的问题，这个好心人利用Azure Function搭建了公共服务，只要授权这个Github Apps访问我的Repository，评论通过它的公共服务触发我的workflow发起Pull Requests，和之前的体验一模一样。当然，我也可以自建这个Public Action Trigger服务，但是要注册Azure账号和要发布Github Apps这两点阻止了我，反正公开服务能用一天就是一天。这个好心人也提到了我之前的想法，也认为Github Token的颗粒度太粗了，希望未来Github能解决这个问题，这样我就又能重构博客系统，并且完全不依赖除Github之外的第三方服务了。&lt;/p&gt;
&lt;p&gt;看到完美解决方案的曙光后，我开始动手实现&lt;a href="https://github.com/jackyzy823/jackyzy823.github.io/tree/source/.github/workflows"&gt;workflow&lt;/a&gt;。一个workflow是发布系统，每当我Push或者我合并评论的Pull Requests，就触发构建命令，生成静态页面内容。另外一个workflow是评论系统，每当有来自&lt;code&gt;repository_dispatch&lt;/code&gt;事件的评论，就发起Pull Requests。&lt;/p&gt;
&lt;p&gt;当然也还是有一贯的缺点，就是我或者别人回复前一条评论，前一条评论的作者无法收到任何通知。思考了一下算了，发送邮件要钱，免费服务又不好用。&lt;/p&gt;
&lt;p&gt;希望之后能重新捡起这个博客，多写点技术内容。&lt;/p&gt;
&lt;p&gt;总结：Github上基于Pull Requests的评论系统，最核心的就是要把安全地使用GITHUB_TOKEN调用API（自建），或者授权Github Apps使用，即交由第三方调用API。&lt;/p&gt;</content><category term="tech"></category><category term="blog"></category><category term="comment"></category></entry><entry><title>WebExtensions踩坑实录</title><link href="https://jackyzy823.github.io/tech/different-behaviors-between-firefox-webextensions-and-chrome-extension.html" rel="alternate"></link><published>2018-08-05T14:17:00+08:00</published><updated>2018-08-05T14:17:00+08:00</updated><author><name>jackyzy823</name></author><id>tag:jackyzy823.github.io,2018-08-05:/tech/different-behaviors-between-firefox-webextensions-and-chrome-extension.html</id><summary type="html">&lt;p&gt;最近研究Radiko锁区(详见&lt;a href="https://jackyzy823.github.io/tech/battle-with-radiko.html"&gt;文章&lt;/a&gt;)，并写浏览器插件绕过限制。自从&lt;code&gt;Firefox Quantum&lt;/code&gt;出现后，Firefox变得更加好用了，因此写浏览器插件考虑了同时 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;最近研究Radiko锁区(详见&lt;a href="https://jackyzy823.github.io/tech/battle-with-radiko.html"&gt;文章&lt;/a&gt;)，并写浏览器插件绕过限制。自从&lt;code&gt;Firefox Quantum&lt;/code&gt;出现后，Firefox变得更加好用了，因此写浏览器插件考虑了同时支持&lt;code&gt;Firefox WebExtensions&lt;/code&gt;和&lt;code&gt;Chrome Extension&lt;/code&gt;，然而在实际编写插件的过程中还是因为两者有不少差异从而踩了不少坑，总结如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;API差异与兼容性&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Manifest&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;applications &lt;/p&gt;
&lt;p&gt;这个key是Firefox需要的，而在Chrome上会报错，但不影响加载使用。解决方案是忽略或者通过构建工具生成两份不同的manifest。（注：Switchyomega好像用的是同样一份manifest，但是没有报错，需研究。）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;permissions -&amp;gt; unlimitStorage&lt;/p&gt;
&lt;p&gt;为了能在chrome.storage中存放大于5MB的内容，必须要声明这项权限。在Firefox的文档中，目前不声明也能存放大于5MB的内容。此外Chrome和Firefox关于这项权限对用户的提示也是不同的，Firefox会显式警告，而Chrome不会。参考&lt;a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1411999"&gt;Document which permissions trigger user prompts in the different browsers&lt;/a&gt;。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;declarativeContent&lt;/p&gt;
&lt;p&gt;目前Firefox不支持，不过有替代方案，参考Stackoverflow上的&lt;a href="https://stackoverflow.com/questions/39252384/is-there-a-ff-equivalent-to-chrome-declarativecontent-onpagechanged"&gt;问题&lt;/a&gt;。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;browser_action&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;两者弹出窗口的UI不是完全一致的。将browser_style设置为true后排版一致，但是细节上还有许多不同。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Firefox调试弹出窗口的UI较麻烦，需要强制所有的弹出窗口不消失，包括系统菜单，忘记取消就导致弹出的窗口关不掉。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;API -&amp;gt; webRequest&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;host permission&lt;/p&gt;
&lt;p&gt;Firefox中，在*.a.com这个页面下，如果想监听这个页面发起的对&lt;em&gt;.b.com的请求（CSS，Script,Image,以及&lt;/em&gt;&lt;em&gt;XMLHttpRequest&lt;/em&gt;*），需要同时将 *.a.com和*.b.com 加入host permission。而Chrome则不用。
Firefox这么做的好处在于不怕影响到别的网站,坏处在于如果你想针对某个第三方服务的话,就得把所有用到它的网站都写进host permission,甚至不得不使用 &lt;code&gt;&amp;lt;all-urls&amp;gt;&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;参考:&lt;a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/webRequest"&gt;WebExtensions-&amp;gt;webRequest&lt;/a&gt;。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;To intercept resources loaded by a page (such as images, scripts, or stylesheets), the extension must have the host permission for the resource as well as for the main page requesting the resource. For example, if a page at "https://developer.mozilla.org" loads an image from "https://mdn.mozillademos.org", then an extension must have both host permissions if it is to intercept the image request.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;filterResponse&lt;/p&gt;
&lt;p&gt;Firefox支持读取并修改返回的内容。这个功能简直太实用了,然而Chrome不支持。&lt;/p&gt;
&lt;p&gt;Chrome中有变通方法，但是又各种使用上的限制。变通方法： 利用&lt;code&gt;redirectURL&lt;/code&gt;将请求通过返回码&lt;code&gt;307 Internal Redirect&lt;/code&gt; 重定向到 &lt;code&gt;Location: &amp;lt;Data Protocol&amp;gt;&lt;/code&gt;。在实际使用过程中遇到不少问题。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;jQuery的ajax请求会把&lt;code&gt;307 Internal Redirect&lt;/code&gt;当作错误响应。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;无法定制返回头信息，会导致XMLHttpRequest的&lt;code&gt;CORS Preflight&lt;/code&gt;失效。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;Data Protocol&lt;/code&gt;会导致非同源问题，例如&lt;code&gt;iframe&lt;/code&gt;加载&lt;code&gt;src&lt;/code&gt;，将&lt;code&gt;src&lt;/code&gt;用&lt;code&gt;Data protocol&lt;/code&gt;代替后，会被浏览器认为非同源，导致拒绝加载。见&lt;a href="https://blog.mozilla.org/security/2017/10/04/treating-data-urls-unique-origins-firefox-57/"&gt;Treating data URLs as unique origins for Firefox 57&lt;/a&gt;。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Chrome上的实现参考：&lt;a href="https://gist.github.com/Rob--W/9654450"&gt;Implementation example of writable response bodies for Chromium extensions (API draft)&lt;/a&gt; 和 &lt;a href="https://docs.google.com/document/d/1iE6M-YSmPtMOsec7pR-ILWveQie8JQQXTm15JKEcUT8"&gt;webRequest response body reading/editing proposal&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;我猜，出于安全性的考虑Chrome是不会实现这个功能的，能修改返回内容实在是太危险了，不清楚Firefox为什么会实现。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;RequsetHeaders&lt;/p&gt;
&lt;p&gt;Firefox的赋值是拼接而不是覆盖，例如原来 &lt;code&gt;header1:key1&lt;/code&gt;, 执行&lt;code&gt;header1 = key2&lt;/code&gt;后结果是&lt;code&gt;header1:key1,key2&lt;/code&gt;。Chrome则是覆盖。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;API-&amp;gt; Downloads&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;如何下载blob内容&lt;/p&gt;
&lt;p&gt;将URL指定成 &lt;code&gt;URL.createObjectURL(new Blob([arraybuffer]))&lt;/code&gt;即可。需要注意的是下载完成后最好&lt;code&gt;URL.revokeObjectURL&lt;/code&gt;防止内存问题。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;API-&amp;gt; Storage&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;getBytesInUse&lt;/p&gt;
&lt;p&gt;Firefox未实现，&lt;a href="https://github.com/kiefferbp/webext-getBytesInUse-polyfill"&gt;polyfill&lt;/a&gt;有严重的性能问题，对内存使用有影响,不建议使用。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;存储编码&lt;/p&gt;
&lt;p&gt;Storage的存储本来的设计并不是针对二进制数据进行存储,而是将JSON序列化后对字符串进行存储。因此如果用Uint8Array存储的话，数据能够正常存储，但是因JSON序列化的原因占用空间翻倍，而用Uint16Array存储的话会导致数据错误，主要涉及到Chrome中的JSON库对Unicode中Invalid Character（UTF-16 surrogate pairs的高位）的处理（处理成Replacement character）。&lt;/p&gt;
&lt;p&gt;在Stackoverflow中有这么一个&lt;a href="https://stackoverflow.com/a/38242192"&gt;回答&lt;/a&gt;。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Unicode codepoints U+D800 to U+DFFF must be avoided: they are invalid in Unicode because they are reserved for UTF-16 surrogate pairs. Some JSON encoders/decoders will replace them with U+FFFD. &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;JSON标准定义:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;However, whether a processor of JSON texts interprets such a surrogate pair as a single code point or as an explicit surrogate pair is a semantic decision that is determined by the specific processor&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;然而在Firefox里没有这个问题。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;XMLHttpRequest In Extension&lt;/p&gt;
&lt;p&gt;在插件中通过XMLHttpRequest跨域请求资源，该资源会被缓存，然后如果浏览器再次请求这个资源就会发生响应头里面独缺Access-Control-Allow-Origin    这种情况，导致该响应被浏览器阻止以防止跨域安全问题。一番搜索后发现 Tim Berners-Lee 伟大的互联网发明人也遇到了这个&lt;a href="https://lists.w3.org/Archives/Public/www-archive/2017Aug/0000.html"&gt;问题&lt;/a&gt;。 解决方法有两个:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;在插件里为每个这种请求的响应补上&lt;code&gt;Access-Control-Allow-Origin&lt;/code&gt;响应头&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;补上&lt;code&gt;Vary: Origin&lt;/code&gt; 参见&lt;a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin#CORS_and_caching"&gt;CORS and caching&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;理论上最正确的解决方法是对方服务器加上&lt;code&gt;Vary: Origin&lt;/code&gt;。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;差异化构建 &lt;/p&gt;
&lt;p&gt;要抹平Chrome与Firefox插件之间的差异确实很困难,差异化构建也许是一种可行的方式,到底是Webpack还是Grunt还是Gulp呢,选择有很多,但没有一种相对标准的方法。有不少可以值得借鉴的项目： &lt;a href="https://github.com/FelisCatus/SwitchyOmega"&gt;Switchyomega&lt;/a&gt; , &lt;a href="https://github.com/nakayuki805/AbemaTVChromeExtension"&gt;AbemaTVChromeExtension&lt;/a&gt; 。&lt;/p&gt;
&lt;p&gt;相关讨论：&lt;a href="https://github.com/mdn/webextensions-examples/issues/286"&gt;Example of generating a manifest for both Firefox and Chrome&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;以上&lt;/p&gt;</content><category term="tech"></category><category term="extension"></category><category term="webextension"></category></entry><entry><title>HLS中的AAC如何合并</title><link href="https://jackyzy823.github.io/tech/how-to-concat-aac-from-hls-streaming.html" rel="alternate"></link><published>2018-07-30T23:09:00+08:00</published><updated>2018-07-30T23:09:00+08:00</updated><author><name>jackyzy823</name></author><id>tag:jackyzy823.github.io,2018-07-30:/tech/how-to-concat-aac-from-hls-streaming.html</id><summary type="html">&lt;p&gt;在研究Radiko的时候,想实现在浏览器插件里把M3U8中所有的AAC保存成一个音频文件。&lt;/p&gt;
&lt;p&gt;如果不限制在浏览器插件中，最简单的方 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;在研究Radiko的时候,想实现在浏览器插件里把M3U8中所有的AAC保存成一个音频文件。&lt;/p&gt;
&lt;p&gt;如果不限制在浏览器插件中，最简单的方法就是 &lt;code&gt;ffmpeg -c copy&lt;/code&gt; 让万能的ffmpeg替你解决一切问题。然而一个插件带一个ffmpeg是不是有点大炮打蚊子？也考虑过替代方案，例如使用基于LLVM的Emscripten将ffmpeg转成Javascript，详见&lt;a href="https://github.com/Kagami/ffmpeg.js/"&gt;ffmpeg.js&lt;/a&gt;。但也似乎过于沉重。此外经过测试，用ffmpeg合并的结果似乎并不正确。&lt;/p&gt;
&lt;p&gt;第二种方法就是简单的拼接，但是拼接带来一个问题：部分播放器只能识别到第一个片段。&lt;/p&gt;
&lt;p&gt;因此，在阅读了相关文档之后终于找到了正确的解决方法。&lt;/p&gt;
&lt;p&gt;首先，这个aac里面包含了什么？
根据http-live-streaming的文档中关于&lt;a href="https://tools.ietf.org/html/draft-pantos-http-live-streaming-23#section-3.4"&gt;Packed Audio&lt;/a&gt;部分的说明:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;A Packed Audio Segment contains encoded audio samples and ID3 tags
   that are simply packed together with minimal framing and no per-
   sample timestamps.  Supported Packed Audio formats are AAC with ADTS
   framing [ISO_13818_7]; MP3 [ISO_13818_3]; AC-3 [AC_3]; and Enhanced
   AC-3 [AC_3].&lt;/p&gt;
&lt;p&gt;A Packed Audio Segment has no Media Initialization Section.&lt;/p&gt;
&lt;p&gt;Each Packed Audio Segment MUST signal the timestamp of its first
   sample with an ID3 PRIV tag [ID3] at the beginning of the segment.
   The ID3 PRIV owner identifier MUST be
   "com.apple.streaming.transportStreamTimestamp".  The ID3 payload MUST
   be a 33-bit MPEG-2 Program Elementary Stream timestamp expressed as a
   big-endian eight-octet number, with the upper 31 bits set to zero.
   Clients SHOULD NOT play Packed Audio Segments without this ID3 tag.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;这个AAC是由ID3标签和ADTS组成的格式。&lt;/p&gt;
&lt;p&gt;ADTS是AAC的一种编码方式，与另一种编码方式ADIF不同，ADTS可以在任意帧解码。因此我们只需要把AAC中的ID3标签去掉，然后在拼接起来就能得到正常的AAC文件了。&lt;/p&gt;
&lt;p&gt;回到之前第一种方法，ffmpeg似乎只把第一个AAC的ID3标签去掉，后面的依然保留，不知道是不是参数设置错误还是什么问题。因此只能手动处理掉ID3标签。&lt;/p&gt;
&lt;p&gt;那么ID3标签的格式又是啥呢？详见ID3官方文档&lt;a href="http://id3.org/id3v2.3.0#ID3v2_header"&gt;ID3标签&lt;/a&gt; 或者Abobe给出的图解&lt;a href="https://helpx.adobe.com/adobe-media-server/dev/timed-metadata-hls-hds-streams.html#id3_tag_introduction"&gt;ID3标签头&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;标签头如下:&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;I&lt;/th&gt;
&lt;th&gt;D&lt;/th&gt;
&lt;th&gt;3&lt;/th&gt;
&lt;th&gt;Version&lt;/th&gt;
&lt;th&gt;Revision&lt;/th&gt;
&lt;th&gt;Flags&lt;/th&gt;
&lt;th&gt;Size&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;1Byte&lt;/td&gt;
&lt;td&gt;1Byte&lt;/td&gt;
&lt;td&gt;1Byte&lt;/td&gt;
&lt;td&gt;1Byte&lt;/td&gt;
&lt;td&gt;1Byte&lt;/td&gt;
&lt;td&gt;1Byte&lt;/td&gt;
&lt;td&gt;4Bytes&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;The bitorder in ID3v2 is most significant bit first (MSB).Most significant bit first (MSB) also known as big endian and network byte order.&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;只需要去掉ID3标签头的10个字节加上Size的值,剩下的就是ADTS,简单合并就可以了。&lt;/p&gt;
&lt;p&gt;如果想进一步了解ID3标签里的PRIV是啥的话，可以自行阅读文档&lt;a href="http://id3.org/id3v2.3.0#Private_frame"&gt;ID3 Private frame&lt;/a&gt;。关于 com.apple.streaming.transportStreamTimestamp 的数值的意义。个人理解这个数值的绝对值是没有意义的，只有两个Timestamp的差值是有意义的。 &lt;code&gt;(stamp2 - stamp1) / (90*1000.0)&lt;/code&gt;的结果就是第一段的秒数。参考资料：&lt;a href="https://blog.csdn.net/qq_32430349/article/details/50218317"&gt;MPEG-2 Program Elementary Stream timestamp 的作用&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;以上&lt;/p&gt;</content><category term="tech"></category><category term="aac"></category><category term="hls"></category><category term="m3u8"></category><category term="concat"></category><category term="http live streaming"></category></entry><entry><title>实战Radiko</title><link href="https://jackyzy823.github.io/tech/battle-with-radiko.html" rel="alternate"></link><published>2018-07-30T23:00:00+08:00</published><updated>2018-07-30T23:00:00+08:00</updated><author><name>jackyzy823</name></author><id>tag:jackyzy823.github.io,2018-07-30:/tech/battle-with-radiko.html</id><summary type="html">&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;我为什么要研究呢？&lt;/p&gt;
&lt;p&gt;还不是为了听&lt;strong&gt;Kalafina倶楽部&lt;/strong&gt;。可是发生了这种事情，大家都不想的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;背景知识&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;PC版实行IP锁区&lt;/li&gt;
&lt;li&gt;Android版实行GPS锁 …&lt;/li&gt;&lt;/ol&gt;&lt;/li&gt;&lt;/ol&gt;</summary><content type="html">&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;我为什么要研究呢？&lt;/p&gt;
&lt;p&gt;还不是为了听&lt;strong&gt;Kalafina倶楽部&lt;/strong&gt;。可是发生了这种事情，大家都不想的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;背景知识&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;PC版实行IP锁区&lt;/li&gt;
&lt;li&gt;Android版实行GPS锁区&lt;/li&gt;
&lt;li&gt;共同点：都是通过一套鉴权接口来生成用于播放的Token&lt;/li&gt;
&lt;li&gt;不同点：传递的参数不同，Android版在Headers里传递GPS信息，而PC版不传。PC版和Android版的鉴权密钥不同&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;利用点&lt;/p&gt;
&lt;p&gt;Android版接口不验证IP，在PC版上实现Android版的鉴权流程，即传递我们伪造的GPS信息和Android版的鉴权密钥。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;封堵点&lt;/p&gt;
&lt;p&gt;Android版接口同样实施IP锁区。想到一个办法，但是仍然有被封堵的可能性：Token分享，即利用日本各县IP（日本Rajiko用户/代理）不断生成Token共享使用。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;鉴权流程&lt;/p&gt;
&lt;p&gt;密钥(&lt;code&gt;Key&lt;/code&gt;): 完整的密钥&lt;/p&gt;
&lt;p&gt;部分密钥(&lt;code&gt;PartialKey&lt;/code&gt;): 从完整的密钥的&lt;code&gt;offset&lt;/code&gt;处开始的&lt;code&gt;length&lt;/code&gt;字节&lt;/p&gt;
&lt;p&gt;鉴权分两步&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;/v2/api/auth1&lt;/p&gt;
&lt;p&gt;请求参数 : &lt;code&gt;platform_info&lt;/code&gt; , &lt;code&gt;user_id&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;响应参数 : &lt;code&gt;token&lt;/code&gt; to be valid, &lt;code&gt;offset&lt;/code&gt; ,&lt;code&gt;length&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;/v2/api/auth2&lt;/p&gt;
&lt;p&gt;请求参数: &lt;code&gt;token&lt;/code&gt; ,&lt;code&gt;platform_info&lt;/code&gt; ,&lt;code&gt;user_id&lt;/code&gt;, &lt;code&gt;PartialKey&lt;/code&gt; ,  &lt;code&gt;connection type&lt;/code&gt; (in android), &lt;code&gt;gps location&lt;/code&gt;(in android)&lt;/p&gt;
&lt;p&gt;响应参数: &lt;code&gt;location&lt;/code&gt; (and your &lt;code&gt;token&lt;/code&gt; is valid for radio stations in this location) / &lt;code&gt;OUT&lt;/code&gt; (ip invalid or gps invalid)&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;PC端中密钥在&lt;code&gt;apps/js/playerCommon.js&lt;/code&gt;里：&lt;code&gt;bcd151073c03b352e1ef2fd66c32209da9ca0afa&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;然而,在Android端密钥被动态链接库保护起来，显然Android端的密钥比PC段长很多。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;如何获取Android版鉴权密钥Partialkey的完整部分&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;HTTPS抓包，修改Auth1的返回的Header中的offset为0和length足够长，让客户端这边吐出足够长的Key (Update：Android 7以上不行,详见android:networkSecurityConfig）&lt;/p&gt;
&lt;p&gt;（Update2: 因为发现安卓上新版本的radiko使用了新的密钥aSmartPhone7o，才有的5中的所有Update)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;写一个Apk通过createPackageContext来调用Radiko的native函数getKeyNative2，也是让他吐出足够长的key &lt;/p&gt;
&lt;p&gt;(Update:如果不想写APK可以尝试使用&lt;a href="https://github.com/zhanghai/BeeShell"&gt;BeeShell&lt;/a&gt;作为Java的REPL运行环境） 主要伪代码： &lt;code&gt;Context mmsCtx = context.createPackageContext("jp.radiko.Player",   Context.CONTEXT_INCLUDE_CODE | Context.CONTEXT_IGNORE_SECURITY);  Class.forName("jp.radiko.k.k", true, mmsCtx.getClassLoader());&lt;/code&gt; &lt;/p&gt;
&lt;p&gt;(Update2:旧版本so可行，新版本好像防范了这个方法，使用BeeShell调用会先回到桌面再进入就退出，跟调试的时候现象一样，估计是加了相关的判断逻辑？)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;逆向。通过逆向可以发现key长度是固定的。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;逆向的难点&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;so经过混淆加壳，需要动态调试。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;脱完第一层壳后内有反调试，反模拟器，反root，验证dex完整性，验证签名正确性等手段。检测出异常之后就退出。这也就是为什么在模拟器/root过的设备中运行不起来的原因。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;其实，反调试等手段还是比较好突破的，因为函数入口点只有一个，只要JMP过去就行了。所以我的Patch里都是一个字节的修改。修改完之后可以让它自行修复so，还原生成鉴权密钥的函数和密钥数据。&lt;/p&gt;
&lt;p&gt;暂时还没研究出自动化分析并修改的方法，所以radiko版本更新一次就要改六个so文件还是蛮吐血的事情。(Update: 自动化工具见我的项目&lt;a href="https://github.com/jackyzy823/radiko_android_kai"&gt;Radiko Android Kai&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;Update: 经过互联网搜索，推测加固的方法是CrackProof。在某次Radiko升级后，之前的脚本失效了，而且变得更加难跟进调试了，怀疑CrackProof加固的技术也升级了，放弃放弃。&lt;/p&gt;
&lt;p&gt;(Update2: 看到一篇文章讲如何逆向CrackProof，结果只有第一步。)&lt;/p&gt;
&lt;p&gt;(Update3: Radiko v8 使用了Flutter，然后竟然把key打包进去了，路径 /assets/flutter_assets/assets/key/，详见&lt;a href="https://github.com/garret1317"&gt;garret&lt;/a&gt;的分析　https://427738.xyz/yt-dlp-rajiko/notes/v8key.html 以及 https://427738.xyz/yt-dlp-rajiko/ 以及 https://github.com/garret1317/yt-dlp-rajiko/blob/f4a74e390da521ef76021b7ba6fdf2874e005311/yt_dlp_plugins/extractor/radiko_key.py ， 以前可是不会犯这个错误的啊，以前是DEBUG版本才会从sdcard路径下读取这个文件)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;还原后的生成函数&lt;/p&gt;
&lt;p&gt;生成鉴权密钥的函数（位于.text段）超级简单：从.data段+0x20+offset处memcpy长度为length的数据作为鉴权密钥。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;PC版的浏览器插件遇到的坑&lt;/p&gt;
&lt;p&gt;详见另一篇&lt;a href="https://jackyzy823.github.io/tech/different-behaviors-between-firefox-webextensions-and-chrome-extension.html"&gt;文章&lt;/a&gt;关于WebExtensions里的各种坑&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Apk修改思路（基于smali）&lt;/p&gt;
&lt;p&gt;此外顺手也把APK给修改了，不从GPS设备获取数据，直接传假数据啦。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;修改鉴权流程方法&lt;/p&gt;
&lt;p&gt;因为破坏了Apk包的完整性,原样调用鉴权流程,会导致退出。解决方法如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;直接替换getPartialkey方法，把第5步中得到的完整的key， 不调用so，也就不怕so检测。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;createPackageContext 调用安装的Radiko，但是本机root的话还是会崩溃。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;修改so绕过检测&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这里我选了第三种，其实第一种更好，因为可以少修改3个so文件。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;伪造GPS&lt;/p&gt;
&lt;p&gt;研究发现APK有DEVELOPER_MODE模式，自带传假数据的接口和选择地区的界面，那我们把DEVELOPER_MODE打开就好，启动后可以选择不同地区。&lt;/p&gt;
&lt;p&gt;这也告诉我们调试用逻辑不要发布到正式版的包里。本来要自己写一个选择地区的界面还是蛮麻烦的，还要考虑程序流程、持久化什么的，现在倒好全都白送啦！&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;绕过Premium和Timeshift、及录音&lt;/p&gt;
&lt;p&gt;绕过Timeshift很简单，让它写本地数据库时一直写最大值，把最长期限从1天改成8天。&lt;/p&gt;
&lt;p&gt;一开始以为Timeshift是一天内最多随便听3小时节目，后来发现是一个节目你点击开始听之后的一天内最多可以听3小时，也就是说过了这一天或者听超过三小时，这个节目就再也听不了了。&lt;/p&gt;
&lt;p&gt;绕过Premium在浏览器拓展里实现了Token管理比较好做，Android上要改太多东西就放弃了，反正退出重进重新选就好了。&lt;/p&gt;
&lt;p&gt;浏览器拓展有录音和往期下载，但是在Android上也比较麻烦，因为也是要改太多东西，考虑是不是能配合raziko。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;其他边边角角的坑&lt;/p&gt;
&lt;p&gt;例如发现Radiko的闪退bug之类的。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;下一步研究计划&lt;/p&gt;
&lt;p&gt;爬完了所有Radiko的ON-AIR曲目，不过并不是所有台都有ON-AIR信息，准备研究J-POP潮流（并不。默默看了下我团的数据，真是十八线中的十八线。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;附上逆向动态调试时写的IdaPython的脚本:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;anadebug&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;segname&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;start&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_first_seg&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_segm_name&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;end&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_segm_end&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;segname&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;segname&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="nb"&gt;print&lt;/span&gt; &lt;span class="nb"&gt;hex&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nb"&gt;hex&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;end&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                &lt;span class="n"&gt;ida_auto&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;plan_and_wait&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;end&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="k"&gt;pass&lt;/span&gt;
        &lt;span class="k"&gt;elif&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;startswith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;debug&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ow"&gt;and&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;get_segm_attr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;SEGATTR_PERM&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;ida_segment&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SEGPERM_EXEC&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="nb"&gt;print&lt;/span&gt; &lt;span class="nb"&gt;hex&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nb"&gt;hex&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;end&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;ida_auto&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;plan_and_wait&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;end&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;start&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_next_seg&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;start&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;BADADDR&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;break&lt;/span&gt;

&lt;span class="n"&gt;run_to&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;get_segm_start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;idautils&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cpu&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;EIP&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mh"&gt;0x406&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;wait_for_next_event&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;WFNE_SUSP&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;anadebug&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;firstseg&lt;/span&gt;  &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_segm_start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;idautils&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cpu&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;EAX&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;run_to&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;firstseg&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mh"&gt;0x37c0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;wait_for_next_event&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;WFNE_SUSP&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;run_to&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;firstseg&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mh"&gt;0x5fe&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;#call eax&lt;/span&gt;
&lt;span class="n"&gt;wait_for_next_event&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;WFNE_SUSP&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;anadebug&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;secondseg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_segm_start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;idautils&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cpu&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;EAX&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;run_to&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;secondseg&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mh"&gt;0x241f&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; 
&lt;span class="n"&gt;wait_for_next_event&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;WFNE_SUSP&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;add_bpt&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;secondseg&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mh"&gt;0x2144&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;run_to&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;secondseg&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mh"&gt;0x2144&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;wait_for_next_event&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;WFNE_SUSP&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;#decrypt seg&lt;/span&gt;
&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="nb"&gt;ord&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;get_bytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;idautils&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cpu&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;EBP&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mh"&gt;0x10&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;!=&lt;/span&gt;&lt;span class="mh"&gt;0xf&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;run_to&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;secondseg&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mh"&gt;0x2144&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;wait_for_next_event&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;WFNE_SUSP&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;del_bpt&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;secondseg&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mh"&gt;0x2144&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;anadebug&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;thirdseg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_segm_start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;idautils&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cpu&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;EAX&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;run_to&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;thirdseg&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mh"&gt;0x41a&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; 
&lt;span class="n"&gt;wait_for_next_event&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;WFNE_SUSP&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;idautils&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cpu&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;EIP&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_item_end&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;idautils&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cpu&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;EIP&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;#jump this call edx&lt;/span&gt;
&lt;span class="c1"&gt;# second+ 0x25f -&amp;gt; 4th seg&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;以上&lt;/p&gt;</content><category term="tech"></category><category term="radiko"></category><category term="reversing"></category></entry><entry><title>不好的锁区设计</title><link href="https://jackyzy823.github.io/tech/bad-geolocation-restriction-design.html" rel="alternate"></link><published>2018-07-30T21:30:00+08:00</published><updated>2018-07-30T21:30:00+08:00</updated><author><name>jackyzy823</name></author><id>tag:jackyzy823.github.io,2018-07-30:/tech/bad-geolocation-restriction-design.html</id><summary type="html">&lt;p&gt;众所周之，日本的互联网服务大部分都是锁区的，非日本IP无法访问。但是总是有一些锁区的设计让我们可以绕过这些限 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;众所周之，日本的互联网服务大部分都是锁区的，非日本IP无法访问。但是总是有一些锁区的设计让我们可以绕过这些限制。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;超级优秀的设计&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href="https://summo.jp"&gt;Summo&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;针对中国IP直接在TCP层面直接RST，不给你留一点机会。LOL。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;失败的设计&lt;/p&gt;
&lt;p&gt;一般而言,不好的锁区设计一般有两种。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;验证前置。&lt;/p&gt;
&lt;p&gt;大多由于锁区判断在前端而不是后端,前端绕过基本没有任何难度。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href="http://fod.fujitv.co.jp"&gt;FOD&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Tv-Asahi&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;信任用户的输入&lt;/p&gt;
&lt;p&gt;我说我的IP是日本IP就相信,是不是有点过于天真了呢? &lt;code&gt;X-Forwarded-For&lt;/code&gt;确实不应该被信任。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Tver&lt;/p&gt;
&lt;p&gt;视频源用的是第三方服务Brightcove。资源API可被&lt;code&gt;X-Forwarded-For&lt;/code&gt;绕过。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;两者皆有&lt;/p&gt;
&lt;p&gt;两种错误都犯的。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Abema.tv&lt;/p&gt;
&lt;p&gt;虽然有两种前端验证，Abema自己的和第三方服务Akamai的，但都能绕过。&lt;/p&gt;
&lt;p&gt;视频源用的是第三方Akamai。资源API可被&lt;code&gt;X-Forwarded-For&lt;/code&gt;绕过。&lt;/p&gt;
&lt;p&gt;Update at 2018/11/1, Akamai已不可绕过。&lt;/p&gt;
&lt;p&gt;Update at 2018/10/5，直播源已经无法通过&lt;code&gt;X-Forwarded-For&lt;/code&gt;绕过，VOD源暂时还可以。通过改变直播源域名变成VOD源域名可以绕过。但目测不会长久。&lt;/p&gt;
&lt;p&gt;Update at 2018/10/5，经过测试替换方式无效，跟推流方式有关，VOD源似乎不是连续的？所以直播还是老老实实挂代理吧。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;一言难尽的设计&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href="http://radiko.jp/"&gt;Radiko&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Radiko提供PC端和移动端的服务,在不同平台上,锁区方式实现也不一样。&lt;/p&gt;
&lt;p&gt;在PC端,通过IP来锁区,X-Forwarded-For无效,虽然验证前置,但是鉴权接口依然在后端判断IP锁区。可以是设计得非常合理。&lt;/p&gt;
&lt;p&gt;在Android端，通过GPS来锁区，鉴权接口与PC端基本一致，但在HTTP头中增加GPS信息，且不验证IP。Android端检测有无root和是否使用虚拟定位。应该说除了不验证IP外，也设计得非常合理。&lt;/p&gt;
&lt;p&gt;但是，关键问题就出在Android端不验证IP，谁又规定PC上不能使用Android端的鉴权方式呢，在PC上伪造一个HTTP头填上想要的GPS信息简直轻而易举。见我的项目-&amp;gt;&lt;a href="https://github.com/jackyzy823/rajiko"&gt;Rajiko&lt;/a&gt; 和 &lt;a href="https://jackyzy823.github.io/tech/battle-with-radiko.html"&gt;文章&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;这种设计就让人感觉一言难尽，明明是想做好的，却功亏一篑。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;正常的设计&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Alicesoft&lt;/p&gt;
&lt;p&gt;前端部署Squid，&lt;code&gt;X-Forwarded-For&lt;/code&gt;无效。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;GYAO&lt;/p&gt;
&lt;p&gt;首先在后端根据IP给出不同的资源页面，区外IP直接提示拒绝服务，如果想强行使用，资源API也会在涉及到关键参数&lt;code&gt;videoId&lt;/code&gt;会在后端进行区域鉴定，不通过就拿不到&lt;code&gt;videoId&lt;/code&gt;的值。同样是使用第三方Brigtcove的服务，而什么GYAO就如此优秀呢？&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;通过以上这些设计的比较我们可以看出：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;不要相信用户的输入，如&lt;code&gt;X-Forwarded-For&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;验证不要放在前端，关键接口要在后端验证&lt;/li&gt;
&lt;li&gt;注意不同平台接口差异&lt;/li&gt;
&lt;li&gt;要求第三方服务加强锁区限制，或提供接口自行验证&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;以上&lt;/p&gt;
&lt;p&gt;P.S: 写了这文章会不会导致锁区加强了呢？&lt;/p&gt;</content><category term="tech"></category><category term="geolocation"></category><category term="restriction"></category><category term="radiko"></category><category term="abema"></category></entry><entry><title>一次微不足道的渗透测试</title><link href="https://jackyzy823.github.io/tech/a-tiny-penetration-test.html" rel="alternate"></link><published>2017-12-10T17:35:00+08:00</published><updated>2017-12-10T17:35:00+08:00</updated><author><name>jackyzy823</name></author><id>tag:jackyzy823.github.io,2017-12-10:/tech/a-tiny-penetration-test.html</id><summary type="html">&lt;p&gt;​​一台机器 通过端口扫描发现 对外开了80 , 8080 , 22端口&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;22端口只支持公钥登录&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;8080架设了某CI服务&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;80架设了某BLOG服务&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;某CI服 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;​​一台机器 通过端口扫描发现 对外开了80 , 8080 , 22端口&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;22端口只支持公钥登录&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;8080架设了某CI服务&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;80架设了某BLOG服务&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;某CI服务需要登录，但是能够注册（手动滑稽），并且注册后的用户有权运行某高性能虚拟机上的动态语言脚本。&lt;/p&gt;
&lt;p&gt;发现某CI服务权限比较低。尝试sudo id，需要输入密码，猜测没有sudo权限或者需要输入密码才能sudo&lt;/p&gt;
&lt;p&gt;翻了翻某CI服务项目的配置，发现了一条有趣的命令 sudo /etc/init.d/XXXX start &lt;/p&gt;
&lt;p&gt;尝试执行该命令不需要密码并且成功执行，看来是在sudoer里设置了只能sudo执行 /etc/init.d/XXXX &lt;/p&gt;
&lt;p&gt;查看该脚本后，发现是一个用jsvc运行某CI服务编译好的项目的jar的服务脚本，jsvc可以指定--user 来降权执行，但是他指定了root，非常漂亮。&lt;/p&gt;
&lt;p&gt;于是想到了替换jar文件为我们的反弹shell来获得一个root权限的shell，然后进行后续操作。&lt;/p&gt;
&lt;p&gt;反编译他的jar或者直接在某CI服务里看代码，参考了jsvc的文档，实现了跟原始jar一致的接口的反弹shell的jar。&lt;/p&gt;
&lt;p&gt;起服务，齐活，成功拿到Shell。查看sudoers验证猜想正确。&lt;/p&gt;
&lt;p&gt;然后就是信息收集&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;某CI服务的里拿到某代码托管服务的用户名和密码&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;从某BLOG服务连接某数据库服务的以世界上最好的语言的编写的配置文件里拿到了数据库用户密码&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;拿某代码托管服务的用户名 和 某数据库服务密码 猜出从某BLOG服务的用户名密码&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;根据IP知道主机提供商是某著名以二次元形象吸引宅男程序员氪金的主机提供商，然后拿某BLOG服务的用户名密码登录&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;以上故事提醒我们&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;这个主机提供商的端口限制白名单功能是非常坑爹的。&lt;/p&gt;
&lt;p&gt;该机器勾选了 22 和 web服务(80,443) 结果没想到自己在8080上的服务暴露出去了。&lt;/p&gt;
&lt;p&gt;所以以后买了机器架好服务，要自己端口扫一下或者通过iptables增加自己的限制，防止被主机提供商坑一把。白名单是好的，但是跟描述不一样的白名单就。。。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;sudo只能执行一个命令这个设置说明用户有一定安全习惯，没有&lt;code&gt;ALL ALL NOPASSWD&lt;/code&gt;，但是运行的程序如果提供了降权功能，也是要用上的。此外要将服务脚本指向的程序的所有者改成&lt;code&gt;root&lt;/code&gt;以防止被第三方随便修改。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;通用密码害死人。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;以上故事纯属虚构，如有巧合概不负责&lt;/p&gt;</content><category term="tech"></category><category term="penetration"></category><category term="test"></category><category term="firewall"></category><category term="privilege"></category></entry><entry><title>Sublime SVN/SFTP 破解</title><link href="https://jackyzy823.github.io/tech/sublime-svn-sftp-license-crack.html" rel="alternate"></link><published>2014-04-29T00:05:36+08:00</published><updated>2023-07-21T00:00:00+08:00</updated><author><name>jackyzy823</name></author><id>tag:jackyzy823.github.io,2014-04-29:/tech/sublime-svn-sftp-license-crack.html</id><summary type="html">&lt;p&gt;注： 本文原来发布在CSDN，但是最近发现文章状态变成了审核未通过，原因是版权问题，于是复制到这边。&lt;/p&gt;
&lt;p&gt;注2： 本文发布时间较 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;注： 本文原来发布在CSDN，但是最近发现文章状态变成了审核未通过，原因是版权问题，于是复制到这边。&lt;/p&gt;
&lt;p&gt;注2： 本文发布时间较早(&lt;strong&gt;2014年&lt;/strong&gt;)，已经失效。在新版本中用"-"来判断新旧Key，有"-"，则为旧key，&lt;strong&gt;并验证如果不在KEY_FILTER（已知的所有旧Key的Bloom Filter）中就是伪造的Key&lt;/strong&gt;。新key用椭圆曲线公私钥的方式验证。目前思路有修改bloom_filter.pyc，修改判断逻辑。&lt;/p&gt;
&lt;p&gt;以下为原文：&lt;/p&gt;
&lt;p&gt;注：使用一段时间后出现&lt;/p&gt;
&lt;p&gt;./sublimesvn/commands.py:4230: UnicodeWarning: Unicode unequal comparison failed to convert both arguments to Unicode - interpreting them as being unequal&lt;/p&gt;
&lt;p&gt;这种问题，虽然不会弹出对话框，但是svn界面会显示unregistered，重启sublime后正常，明日早起研究&lt;/p&gt;
&lt;p&gt;注：测试环境 Ubuntu14.10 Sublime Text 2 2221&lt;/p&gt;
&lt;p&gt;window下将&lt;code&gt;sys.path.append('~/.config/sublime-text-2/Packages/SVN')&lt;/code&gt;里的路径改成sublime-&amp;gt;perferences-&amp;gt;browser package所在的路径&lt;/p&gt;
&lt;p&gt;&lt;code&gt;import sys;sys.path.append('~/.config/sublime-text-2/Packages/SVN');config={'email':"your_email_1",'product_key':'test'};from sublimesvn import commands;commands.SvnCommand.setup_elements(config);print commands.SvnCommand.get_prefix()&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;email填自己的email，product_key暂时随便填&lt;/p&gt;
&lt;p&gt;由于sublimesvn的pyc都是python2.6环境下生成的，所以必须调出sublime的console (Ctrl+`)，将以上代码复制进去 ，而不能用python，ipython之类的&lt;/p&gt;
&lt;p&gt;当然如果还在用python2.6的话忽略以上一句&lt;/p&gt;
&lt;p&gt;把最后算出来的值作为product_key和email放入svn.sublime-settings即可&lt;/p&gt;
&lt;p&gt;算了一个供试用&lt;/p&gt;
&lt;p&gt;SVN&lt;/p&gt;
&lt;p&gt;email:cracked_by_jackyzy823
product_key:fb1255-184296-6565ae-ac9efd-2c6c30&lt;/p&gt;
&lt;p&gt;SFTP&lt;/p&gt;
&lt;p&gt;email:cracked_by_jackyzy823&lt;/p&gt;
&lt;p&gt;product_key:a69fef-050040-e39de9-b2720f-64a9fc&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;但是我用什么email 算出来都是这个值。。。。
更正：因为setup_element 在Svncommand类里有elements时不会覆盖之。。重启一下sublime就好了&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;在&lt;/p&gt;
&lt;p&gt;SublimeText  -&amp;gt; Preferences -&amp;gt; Package Settings -&amp;gt; SFTP/SVN -&amp;gt; Setting Users&lt;/p&gt;
&lt;p&gt;中增加以下内容
{&lt;/p&gt;
&lt;p&gt;"email":"your_email",&lt;/p&gt;
&lt;p&gt;"product_key":"calced_product_key"&lt;/p&gt;
&lt;p&gt;}&lt;/p&gt;
&lt;p&gt;完成激活&lt;/p&gt;
&lt;p&gt;sftp&lt;/p&gt;
&lt;p&gt;在sftp里get_prefix 并没有单独成为一个函数，虽然可以通过svn的get_prefix破解但是稍微有些麻烦，等有空把get_prefix函数研究透彻再更新。&lt;/p&gt;
&lt;p&gt;commands.Svncommand.get_prefix 是通过使用decompile++反编译commands.pyc得到的，但是由于可能代码做了混淆，所以这段代码反编译不是十分清晰。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;sftp代替方案
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;calc_key_sftp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;email&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;elements&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;email&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;sftp_flags&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;ssh_key_file&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;psftp&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
    &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;hmac&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;encode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;utf-8&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;digest&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;将email输入函数 将输出值代替以下代码的calc_key_sftp("email") 就可以算出sftp的product_key&lt;/p&gt;
&lt;p&gt;注：需安装有sublime svn&lt;/p&gt;
&lt;p&gt;&lt;code&gt;import sys;sys.path.append('~/.config/sublime-text-2/Packages/SVN');from sublimesvn import commands;commands.SvnCommand.elements=[0,calc_key_sftp(''email')];print commands.SvnCommand.get_prefix()&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;与此同时 &lt;/p&gt;
&lt;p&gt;svn也有同样的不讨好方法&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;calc_key_svn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;email&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;elements&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;email&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;status&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;checkout&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;diff&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
    &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;hmac&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;encode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;utf-8&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;digest&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;注释同sftp&lt;/p&gt;
&lt;p&gt;&lt;code&gt;import sys;sys.path.append('~/.config/sublime-text-2/Packages/SVN');from sublimesvn import commands;commands.SvnCommand.elements=[0,calc_key_svn(''email')];print commands.SvnCommand.get_prefix()&lt;/code&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;更新：&lt;/p&gt;
&lt;p&gt;将cal函数 lambda 化&lt;/p&gt;
&lt;p&gt;svn&lt;/p&gt;
&lt;p&gt;&lt;code&gt;import sys,hmac;sys.path.append('~/.config/sublime-text-2/Packages/SVN');from sublimesvn import commands;calc_key_svn=lambda x: hmac.new("diff",hmac.new("checkout",hmac.new("status",hmac.new(x,x).digest()).digest()).digest()).digest();commands.SvnCommand.elements=[0,calc_key_svn("your_email")];print commands.SvnCommand.get_prefix()&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;sftp(需在svn存在情况下)&lt;/p&gt;
&lt;p&gt;&lt;code&gt;import sys,hmac;sys.path.append('~/.config/sublime-text-2/Packages/SVN');from sublimesvn import commands;calc_key_sftp=lambda x: hmac.new("psftp",hmac.new("ssh_key_file",hmac.new("sftp_flags",hmac.new(x,x).digest()).digest()).digest()).digest();commands.SvnCommand.elements=[0,calc_key_sftp("your_email")];print commands.SvnCommand.get_prefix()&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;​&lt;/p&gt;</content><category term="tech"></category></entry></feed>