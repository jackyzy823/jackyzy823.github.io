<!DOCTYPE html>
<html lang="zh_cn">
  <head>
        <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=endge, chrome=IE8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width, user-scalable=no" />
    <title>QMailAgent架构分析及破解 — 君に会いたい ...Sprinter</title>
    <!--[if lte IE 8]><script type="text/javascript" src="https://jackyzy823.github.io/theme/js/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" type="text/css" href="https://jackyzy823.github.io/theme/css/skeleton.css" />
    <link rel="stylesheet" type="text/css" href="https://jackyzy823.github.io/theme/css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="https://jackyzy823.github.io/theme/css/theme.css" />
    <link rel="stylesheet" media="not print" type="text/css" href="https://jackyzy823.github.io/theme/css/pygments.css" /> 
    <link rel="shortcut icon" type="image/png" href="https://jackyzy823.github.io/favicon.png" />
    <!--[if lte IE 8]><link rel="shortcut icon" type="image/x-icon" href="https://jackyzy823.github.io/favicon.ico" /><![endif]-->
    <link rel="alternate" type="application/atom+xml"
                           title="君に会いたい ...Sprinter — jackyzy823"
                           href="https://jackyzy823.github.io/feeds/all.atom.xml" />

    <meta name="author"   content="jackyzy823" />
    <meta name="keywords" content="QMailAgent, crack, analysis, 破解" />
    <meta name="description" content="注: 本次破解仅在QMailAgent 3.1.1下测试通过，不对未来版本做保证。 起因 受够了Gmail网页版的内存占用及其他一系列的心理障碍 …"/>
    
    <meta property="og:title" content="QMailAgent架构分析及破解" />
    <meta property="og:url" content="https://jackyzy823.github.io/tech/qmailagent-analysis-and-crack.html" />
    <link rel="canonical" href="https://jackyzy823.github.io/tech/qmailagent-analysis-and-crack.html"/>
  </head>
  <body>
    <a name="top"></a>
    <div id="page">
      <header id="page-head">
        <h1>
          <a href="https://jackyzy823.github.io/index.html">君に会いたい ...Sprinter</a>
        </h1>
      </header>
      <div id="page-body">
        <article class="post" id="page-main" role="main">
      <header class="post-header">
        <h2>
          <a rel="bookmark"
             href="https://jackyzy823.github.io/tech/qmailagent-analysis-and-crack.html"
             title="Permanent link to «QMailAgent架构分析及破解»">
             QMailAgent架构分析及破解
          </a>
        </h2>
        <div class="meta">
            Date: <time datetime="2022-06-20T14:32:00+08:00" title="2022-06-20T14:32:00+08:00">Mon 20 June 2022</time>              <br />Language: 
              [<a href="https://jackyzy823.github.io/tech/qmailagent-analysis-and-crack.html">zh_cn</a>]              <a href="https://jackyzy823.github.io/tech/qmailagent-analysis-and-crack-en.html">en</a>
        </div>
      </header>
      <div class="post-content"> 
        <p>注: 本次破解仅在QMailAgent 3.1.1下测试通过，不对未来版本做保证。</p>
<h2>起因</h2>
<p>受够了Gmail网页版的内存占用及其他一系列的心理障碍，迫切需要一个自建的支持一个登陆帐号内包含多个不同提供商(Gmail,Outlook等)的邮箱帐号的多平台（至少Web和安卓）聚合邮件系统(mail aggregator)。然而找了一圈市面上的解决方案都不符合我的心意。</p>
<p>Roundcube不支持多帐号，安卓上也没有客户端。NextCloud Mail虽然不错，可惜我没有NextCloud生态。也看过SOGOs和Horde都不太符合心意。</p>
<p>还有就是 QMailAgent 主要是因为家里有NAS且有安卓客户端，在有公网IP的情况下，安卓端的作用可以最大化。但是由于我想收Gmail,然而此地受限网络环境不允许。</p>
<p>我甚至动了自己写的心，包括但不限于修改NextCloud Mail或QMailAgent使其独立于其平台，但是开发安卓客户端实在是太麻烦了。最终还是妥协了，选择了QMailAgent，使用透明代理改造了本地的网络，使之能访问GMail。</p>
<h2>经过</h2>
<p>在尝试魔改QMailAgent的时候，对其进行了逆向工程，分析了其架构，并破解了Premium的限制。</p>
<ul>
<li>代码分析</li>
</ul>
<p>通过下载<a href="https://download.qnap.com.cn/QPKG/qmailagent_3.1.1_20220524_x86_64.zip">QPKG包</a>并使用<a href="https://github.com/max-boehm/qnap-utils">工具</a> 解包，其中的Python字节码(*.pyc) 可以通过uncompyle6来反编译。</p>
<p>纵览代码可以发现QMailAgent整体上是由RoundCube 1.1.2加上自己写的Plugins（包括多帐号，备份还原，与FileStation交互等功能）在加上部分用于处理IMAP和POP3的Python库组成，例如 offlineimap ，例如使用Got-your-back 0.21 (非常老旧的版本)来支持GMail的获取。</p>
<ul>
<li>Premium破解</li>
</ul>
<p>接下来就是Premium破解，不建议从license文件本身入手，因为我有过失败的尝试经历，除非一辈子不联网，否则QNAP是强制网络验证license的，比较难搞。</p>
<p>通过前端的入口 <code>_task=license&amp;_action=get_info</code> 找到 <code>data/web/plugins/license/license.php</code> 中的 <code>$this-&gt;register_action('get_info', array($this, 'get_info_ajax'));</code>,进而找到<code>get_info_ajax</code> 函数，这里发现其调用了一个明显混淆过的函数<code>$info = $this-&gt;rcmail-&gt;license-&gt;wbf2d66a297();</code>，找到其定义的php文件<code>data/web/program/lib/Qmail/obfuscator/qmail_license.php</code>，显然obfuscator文件夹下的php文件都进行过混淆以保护代码，虽然可以手动恢复，但为了以后方便还是写了一个脚本自动反混淆，再用格式美化工具格式化一下就可以轻松阅读，甚至能够运行，至少直接<code>php xx.php</code>不会报错。</p>
<p>通过搜索所有包含<code>qmail_license.php</code>中的类名及<code>-&gt;license</code>的代码，发现所有付费功能在调用前都没有验证license，这也可以从<code>data/web/plugins/license/license.min.js</code>前端代码中进一步得到验证，又是可爱的前端验证，详见<a href="https://jackyzy823.github.io/tech/bad-geolocation-restriction-design.html">之前的文章</a>。这和QSirch、CAIYIN MediaSign之类的有所不同，它们都是在后端二进制文件中验证license的，相比而言防御等级更胜一筹。</p>
<p>所以可以通过Console控制台(F12)或者油猴等方式，每次运行时绕过前端的验证。也可以在代码前面加上<code>javascript:</code>后<a href="https://stackoverflow.com/questions/18872679/function-as-google-chrome-bookmark">存入书签</a>，放在书签栏上。因为用到Premium功能的频率不高，我觉得通过Console控制台(F12)修改是可以接受的。</p>
<p>QNAP通过iframe的形式整合QMailAgent及其他应用，QMailAgent 的 iframe的id为 ext-gen+随机数+qmail ，因此可以通过css属性来找到这个iframe，详细javscript如下，伪造了一个到2099-12-31到期的license:
<div class="highlight"><pre><span></span><code><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;[id^=ext-gen][id$=qmail]&#39;</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">k</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">rcmail</span><span class="p">.</span><span class="nx">license</span><span class="p">.</span><span class="nx">stop_refresh</span><span class="p">();</span>
<span class="w">  </span><span class="nx">k</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">rcmail</span><span class="p">.</span><span class="nx">license</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="s2">&quot;info&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;license&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;valid&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Default&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Default&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;info&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;valid_from&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;valid_until&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;apply_date&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;enable_func&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;add_account&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;expired_soon&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;valid&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Test&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Test&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;info&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;valid_from&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2020-01-01&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;valid_until&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2099-12-31&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;apply_date&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2020-01-01&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;enable_func&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;add_account&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;backup&quot;</span><span class="w"> </span><span class="o">:</span><span class="p">{},</span><span class="w"> </span><span class="s2">&quot;restore&quot;</span><span class="o">:</span><span class="p">{},</span><span class="w"> </span><span class="s2">&quot;merge&quot;</span><span class="o">:</span><span class="p">{},</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;expired_soon&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="s2">&quot;merge_func&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;add_account&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;valid_from&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;valid_until&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;apply_date&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;expired_soon&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;backup&quot;</span><span class="w"> </span><span class="o">:</span><span class="p">{},</span><span class="w"> </span><span class="s2">&quot;restore&quot;</span><span class="o">:</span><span class="p">{},</span><span class="w"> </span><span class="s2">&quot;merge&quot;</span><span class="o">:</span><span class="p">{},</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;is_premium&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;unlimit&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>
<span class="p">}</span><span class="w"> </span><span class="p">)</span>
</code></pre></div></p>
<p>如果是直接以<code>http://NAS/qmail</code>形式访问QMailAgent则可以简化为：</p>
<div class="highlight"><pre><span></span><code><span class="nx">rcmail</span><span class="p">.</span><span class="nx">license</span><span class="p">.</span><span class="nx">stop_refresh</span><span class="p">()</span>
<span class="nx">rcmail</span><span class="p">.</span><span class="nx">license</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="s2">&quot;info&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;license&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;valid&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Default&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Default&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;info&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;valid_from&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;valid_until&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;apply_date&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;enable_func&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;add_account&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;expired_soon&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;valid&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Test&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Test&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;info&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;valid_from&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2020-01-01&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;valid_until&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2099-12-31&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;apply_date&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2020-01-01&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;enable_func&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;add_account&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;backup&quot;</span><span class="w"> </span><span class="o">:</span><span class="p">{},</span><span class="w"> </span><span class="s2">&quot;restore&quot;</span><span class="o">:</span><span class="p">{},</span><span class="w"> </span><span class="s2">&quot;merge&quot;</span><span class="o">:</span><span class="p">{},</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;expired_soon&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="s2">&quot;merge_func&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;add_account&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;valid_from&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;valid_until&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;apply_date&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;expired_soon&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;backup&quot;</span><span class="w"> </span><span class="o">:</span><span class="p">{},</span><span class="w"> </span><span class="s2">&quot;restore&quot;</span><span class="o">:</span><span class="p">{},</span><span class="w"> </span><span class="s2">&quot;merge&quot;</span><span class="o">:</span><span class="p">{},</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;is_premium&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;unlimit&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>
</code></pre></div>
<p>因为所有付费功能在调用前都没有验证license，所以如果能SSH连进NAS的话可以直接调用<code>/mnt/ext/opt/qmail/web/restoreworker.sh</code>和<code>/mnt/ext/opt/qmail/web/backupworker.sh</code>等工具。</p>
<p>甚至可以更加直接一点，通过mysqldump命令备份数据库，并手动备份邮件存储的文件夹。需要恢复的时候，再导入即可。 其中mysql数据库的连接方式为  <code>/usr/local/mariadb/bin/mysql -uroundcube -pmypassword  -S /mnt/ext/opt/qmail/var/qmail_mysqld.sock</code></p>
<ul>
<li>使用透明代理改造本地网络</li>
</ul>
<p>改造本地网络前提是gmail、google accounts和googleapis域名没有被污染， 如果污染了就要另外增加自建DNS的步骤。google本身的主域名被污染无所谓。</p>
<p>我们要做的就是让所有google的IP经过我们的透明代理，那么Google的IP哪里查呢？像这些大厂都会公布自己的IP段，供运维人员配置防火墙等等，可以从<code>https://www.gstatic.com/iprange/goog.json</code>获取所有的IP段，令人惊奇的是www域名（指向了国内的IP，北京谷歌云）没被墙，而裸域名被墙了。</p>
<p>使用SSH连接NAS，首先 <code>sudo ipset create google hash:net family inet</code> 建立google的IP集合。然后 <code>curl https://www.gstatic.com/ipranges/goog.json |  jq -r ".prefixes[].ipv4Prefix | values"  | xargs -n 1 sudo ipset add google</code> 将Google的IP加入集合中(这里我们暂时不考虑ipv6)。接下来建立iptables的转发规则将命中Google IP的流量转发到透明代理，其他流量原样处理(这里我们暂时只考虑TCP协议)。</p>
<div class="highlight"><pre><span></span><code>sudo iptables -t nat -N google
sudo iptables -t nat -A google -m set ! --match-set google dst -j RETURN
sudo iptables -t nat -A google -p tcp -j REDIRECT --to-ports 2080
sudo iptables -t nat -A PREROUTING -j google
sudo iptables -t nat -A OUTPUT -p tcp  -j google
</code></pre></div>
<p>最后，使用QNAP的Container Station创建透明代理的container。这里需要注意的是container的网络模式必须为host模式，这样透明代理程序才能通过iptables知道修改前的源IP、端口，否则无法转发。你可以使用任何你喜欢的支持透明代理模式的工具。别忘了设置自动启动。</p>
<p>改造完成后别忘了通过开机启动项autorun.sh (Control Panel-&gt;System-&gt;Hardware-&gt;General-&gt;Run user defined processes during startup) 来持久化操作，因为每次重启后iptables都不会保存。具体内容为之前所有的命令，把sudo去除即可。</p>
<h2>结果</h2>
<p>真香</p>
<h2>One More Thing</h2>
<p>最近听闻K-9加入ThunderBird，就在想Thunderbird能不能出个Headless的然后扔在VPS上收邮件，然后本地ThunderBird和安卓端通过WEB API来访问/同步。
或者加入FxA全家桶，利用Firefox Sync来同步设置邮件（可能对对于Mozilla来说负担有些大）。</p>
<p>Update 2022-07-31:
刚刚看syncstorage-rs的issue是发现了<a href="https://github.com/mozilla-services/syncstorage-rs/issues/1363">Thunderbird也要开始使用Firefox Sync</a>以及<a href="https://thunderbird.topicbox.com/groups/planning/T0032198a6351e77d/proposal-firefox-sync-in-114-should-be-called-thunderbird-sync">将Firefox Sync重命名为Mozilla Sync的讨论</a>。搜索了一下关于ThunderBird 114(2023年)相关的<a href="https://www.ghacks.net/2022/07/25/thunderbirds-next-milestone-release-will-support-firefox-sync/">新闻</a>,真是令人期待。从<a href="https://developer.thunderbird.net/planning/roadmap#firefox-sync">Roadmap</a>来看 1. 起码要等到年底甚至更久。 2. Android端（也就是K9）也会支持，应该说正是因为收购了Android端才开始考虑同步这个功能。 3. 只同步邮箱设置，不同步邮件内容。可以理解，毕竟Sync提供的存储有上限也不大。不如搞成收费的来缓解财政压力，可以学习现在流行的订阅制收费模式嘛。</p>
<p>附： 反混淆用的Python脚本 <del>无内鬼，来点正则表达式笑话。</del>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">re</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">zlib</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Usage: deobfs xxx.php&quot;</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">()</span>


<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1">## Remove define</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;define\(.*?\);&quot;</span><span class="p">,</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> 

<span class="c1">## Extract gz content</span>
<span class="n">res</span>  <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">rb</span><span class="s2">&quot;&quot;&quot;(?s)\$(.*?)\[(.*?)\]\s=\sexplode\(&#39;(.*?)&#39;\s*,\s*gzinflate\(substr\(&#39;(.*?)&#39;\s*,(.*?)\s*,(.*?)\s*\)\)\);&quot;&quot;&quot;</span> <span class="p">,</span> <span class="n">s</span><span class="p">[:</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;)));&#39;</span><span class="p">)</span> <span class="o">+</span><span class="mi">4</span>  <span class="p">]</span> <span class="p">)</span> 
<span class="n">global_obj</span> <span class="p">,</span> <span class="n">global_key</span> <span class="p">,</span> <span class="n">split_key</span> <span class="p">,</span>  <span class="n">gz</span> <span class="p">,</span> <span class="n">start</span> <span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">gz1</span> <span class="o">=</span> <span class="n">gz</span><span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span><span class="mi">16</span><span class="p">)</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">decode</span><span class="p">())]</span>

<span class="c1"># TODO: https://www.php.net/manual/en/language.types.string.php</span>
<span class="c1">## \r \v \e \f</span>
<span class="n">gz1</span> <span class="o">=</span> <span class="n">gz1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">rb</span><span class="s2">&quot;\&#39;&quot;</span> <span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\&#39;</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">rb</span><span class="s1">&#39;\&quot;&#39;</span> <span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">rb</span><span class="s1">&#39;\$&#39;</span> <span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;\$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">rb</span><span class="s1">&#39;\n&#39;</span> <span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">rb</span><span class="s1">&#39;\t&#39;</span> <span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">rb</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># beacuse php escape it</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompressobj</span><span class="p">(</span><span class="o">-</span><span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="p">)</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">gz1</span><span class="p">)</span>
<span class="n">gl</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">split_key</span><span class="p">)</span>

<span class="n">s1</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;)));&#39;</span><span class="p">)</span> <span class="o">+</span><span class="mi">4</span>  <span class="p">]</span>
<span class="n">s2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">rb</span><span class="s2">&quot;&quot;&quot;(?s)\$(.*?)\[(.*?)\]\s=\sexplode\(&#39;(.*?)&#39;\s*,\s*gzinflate\(substr\(&#39;(.*?)&#39;\s*,(.*?)\s*,(.*?)\s*\)\)\);&quot;&quot;&quot;</span> <span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">s1</span> <span class="p">)</span> 
<span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">)</span>

<span class="c1">## Remove `$KEY = &amp;_GLOBAL` and Replace all $KEY to $_GLOBAL</span>
<span class="n">ref_args</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">rb</span><span class="s2">&quot;&quot;&quot;\$([^\)]*?)\=\&amp;\$&quot;&quot;&quot;</span> <span class="o">+</span><span class="n">global_obj</span><span class="p">,</span><span class="n">s</span> <span class="p">)</span>
<span class="n">ref_args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ref_args</span><span class="p">))</span> <span class="c1">#dedupe</span>
<span class="n">ref_args</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ref_arg</span> <span class="ow">in</span> <span class="n">ref_args</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$&#39;</span> <span class="o">+</span> <span class="n">ref_arg</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;=&amp;$&quot;</span> <span class="o">+</span> <span class="n">global_obj</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="n">global_key</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;];&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$&#39;</span><span class="o">+</span> <span class="n">ref_arg</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;$&#39;</span> <span class="o">+</span> <span class="n">global_obj</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="n">global_key</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;][&#39;</span> <span class="p">)</span>

<span class="c1">## Replace malformed arguments</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">rb</span><span class="s1">&#39;&#39;&#39;(\$[\W]*?)[\=|\!|,|)|\[|&gt;|\]|\-|\:|\.|\;|\&lt;]&#39;&#39;&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>

<span class="n">rep</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
<span class="n">rep</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rep</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">v</span> <span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;$arg&quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="p">)</span>

<span class="c1">## Replace dict with its item.</span>
<span class="k">def</span> <span class="nf">replace_word</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">word</span> <span class="o">=</span>  <span class="n">gl</span><span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span><span class="mi">16</span><span class="p">)</span>  <span class="p">]</span>
    <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span> <span class="sa">b</span><span class="s2">&quot;DateTime&quot;</span> <span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;DateTimeZone&quot;</span> <span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;restoreworker&quot;</span> <span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;backupworker&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">word</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">word</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;&quot;&#39;</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">rb</span><span class="s1">&#39;\$&#39;</span> <span class="o">+</span>  <span class="n">global_obj</span>  <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;\[&#39;</span><span class="o">+</span> <span class="n">global_key</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;\]\[(.*?)\]&#39;</span> <span class="p">,</span> <span class="n">replace_word</span> <span class="p">,</span> <span class="n">s</span> <span class="p">)</span>

<span class="c1">## Output</span>
<span class="k">with</span>  <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.dec&quot;</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div></p>
      </div>
      <footer class="post-footer">
        <div class="meta">
            Posted in «<a href="https://jackyzy823.github.io/category/tech.html">tech</a>» 
            by <a href="https://jackyzy823.github.io/author/jackyzy823.html">jackyzy823</a><br />
              Tags:  #<a href="https://jackyzy823.github.io/tag/qmailagent.html">QMailAgent</a> #<a href="https://jackyzy823.github.io/tag/crack.html">crack</a> #<a href="https://jackyzy823.github.io/tag/analysis.html">analysis</a> #<a href="https://jackyzy823.github.io/tag/po-jie.html">破解</a>        </div>
        <br/>
        <ul>
              <li>Prev:
                  <a href="https://jackyzy823.github.io/tech/zorin-os-pro-upgrade.html">
                      白嫖(破解)Zorin OS Pro/Ultimate
                  </a>
              </li>
              <li>Next:
                  <a href="https://jackyzy823.github.io/rambling/compare-fujitsu-lifebook-u7x11-u7x12.html">
                      Fujitsu Lifebook U7x12 与 U7x11对比
                  </a>
              </li>
         </ul>
      </footer>
      <div id="comment-post">
        <h3>Leave a comment</h3>
        <p>Note : Your comment will not be displayed until a Github PullRequest have been merged.</p>
        <noscript><p>Note2: Require Javascript to submit a comment.</p></noscript>
        <script type="text/javascript" src="https://jackyzy823.github.io/theme/js/spark-md5.min.js"></script>
        <script type="text/javascript">
            var comment = function(button){
              if ( !window.event.target.parentElement.reportValidity() ){
                return;
              }

              let keywords = ["slug" , "name" , "email" , "url" , "comment" , "replyto"];

              let payload = {};
              keywords.forEach(function(item, index) {
                  payload[item] = document.getElementById("comment-"+item).value;
              });
              payload["email"] = SparkMD5.hash(payload["email"]);
              fetch("https://publicactiontrigger.azurewebsites.net/api/dispatches/jackyzy823/jackyzy823.github.io", {
                method: 'POST',
                mode: 'cors',
                credentials: 'omit',
                cache: 'no-cache',
                redirect: 'error',
                referrerPolicy: 'no-referrer',
                body: JSON.stringify({ event_type: 'comment', client_payload: { data: payload } })
              }).then(function(resp){
                if(resp.ok){
                  document.getElementById("comment-result").textContent = "Success."
                } else if (resp.status == 422){
                  resp.text().then(
                    function(msg){
                      document.getElementById("comment-result").textContent = "Error: "+msg;
                    })
                }
              });
            }

        </script>
        <form>
            <input id="comment-slug" name="options[slug]" type="hidden" value="qmailagent-analysis-and-crack">
            <p><label>Name:</label> <input id="comment-name" name="fields[name]" type="text" placeholder="(Required)" required="required"></p>
            <p><label>E-mail:</label> <input id="comment-email" name="fields[email]" type="email" placeholder="(Required to calcuate MD5 for displaying avatar)" required="required"></p>
            <p><label>Website:</label> <input id="comment-url" name="fields[url]" type="text" placeholder="(Optional)"></p>
            <p><label>Comment:</label> <textarea id="comment-comment" name="fields[comment]" rows=5 required="required"></textarea></p>
            <p><label>Reply To(<a alt="Clean replyto" onclick="document.getElementById('comment-replyto').value = null">Clear</a>):</label>
              <input id="comment-replyto" name="fields[replyto]" type="text" placeholder="(Empty if directly replying to this article)" readonly></p>
            <input type="button" value="Submit" onclick="comment()" ></input>
            <p id="comment-result"></p>
        </form>
      </div>

      </article> 
        <aside id="page-side">
          <nav>
            <h3>Pages</h3>
            <ul>
              <li><a href="https://jackyzy823.github.io/">Home</a></li>
              <li><a href="https://jackyzy823.github.io/categories.html">Categories</a></li>
              <li><a href="https://jackyzy823.github.io/archives.html">Archives</a></li>
              <li><a href="https://jackyzy823.github.io/tags.html">Tags</a></li>
              <li><a href="https://jackyzy823.github.io/about.html">About</a></li>
              <li><a href="https://jackyzy823.github.io/projects.html">Projects</a></li>
              <li><a href="https://jackyzy823.github.io/random-thoughts.html">Random Thoughts</a></li>
              <li><a href="https://jackyzy823.github.io/self-hostings.html">Self Hostings</a></li>
            </ul>
          </nav>

          <nav>
            <h3>Categories</h3>
            <ul>
              <li><a href="https://jackyzy823.github.io/category/monthly.html">monthly</a></li>
              <li><a href="https://jackyzy823.github.io/category/rambling.html">rambling</a></li>
              <li class="active"><a href="https://jackyzy823.github.io/category/tech.html">tech</a></li>
            </ul>
          </nav>

          <nav>
            <h3>Links</h3>
            <ul>
              <li><a href="https://jackyzy823.github.io/feeds/all.atom.xml">Feed(Atom)</a></li>
              <li><a href="https://github.com/jackyzy823">me@github</a></li>
              <li><a href="https://twitter.com/jackyzy823">me@twitter[NSFW]</a></li>
            </ul>
          </nav>
</aside>       </div>        <footer id="page-foot">
        <p> Powered by <a href="http://pelican.readthedocs.org">Pelican</a><br>
          Built with <a href="https://docs.github.com/en/actions">Github Actions</a><br/>
          Theme <strong>Hikaru</strong> based on <a href="https://github.com/getpelican/pelican-themes/tree/master/dev-random2">dev-random2</a> and <strong>Akai</strong> by <a href="https://www.soimort.org">Soimort</a></br/>
          Comments via <a href="https://github.com/benkaiser">benkaiser</a>'s <a href="https://github.com/apps/public-action-trigger">Public Action Trigger</a> and my <a href="https://github.com/jackyzy823/jackyzy823.github.io/tree/source/.github/workflows">workflow</a>
          </p>
          <a href="#top">Back To Top</a>
      </footer>
    </div>   </body>
</html>